<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Photo Studio: NƒÉm C√¥ng C·ª• S√°ng T·∫°o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lobster&family=Pacifico&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .tool-card { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; flex: 1 1 300px; }
        .tool-card:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .theme-card, .aspect-ratio-card, .body-card, .person-count-card, .festival-card, .lookbook-style-card, .hairstyle-card, .shot-type-card, .dress-length-card, .color-card, .resolution-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; position: relative; }
        .theme-card:hover, .aspect-ratio-card:hover, .body-card:hover, .person-count-card:hover, .festival-card:hover, .lookbook-style-card:hover, .hairstyle-card:hover, .shot-type-card:hover, .dress-length-card:hover, .color-card:hover, .resolution-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .result-card { transition: box-shadow 0.2s ease-in-out; position: relative; }
        .result-card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08); }
        .tooltip { visibility: hidden; opacity: 0; width: 180px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 115%; left: 50%; margin-left: -90px; transition: opacity 0.3s; font-size: 0.8rem; font-weight: 400; line-height: 1.4; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .theme-card:hover .tooltip, .body-card:hover .tooltip, .festival-card:hover .tooltip, .lookbook-style-card:hover .tooltip { visibility: visible; opacity: 1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        #closeModal { font-size: 2rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        #closeModal:hover { background-color: rgba(0,0,0,0.75); }
        .aspect-ratio-card.selected, .body-card.selected, .theme-card.selected, .person-count-card.selected, .festival-card.selected, .lookbook-style-card.selected, .hairstyle-card.selected, .shot-type-card.selected, .dress-length-card.selected, .color-card.selected, .resolution-card.selected { border: 2px solid #2563eb; background-color: #eff6ff; box-shadow: 0 6px 15px rgba(37, 99, 235, 0.2); }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        canvas { cursor: grab; }
        .dragging { cursor: grabbing; }
        /* Custom scrollbar for watermark tool */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .align-btn-active { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; z-index: 5; }
        .thumbnail { cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; }
        .thumbnail.active { border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500 mb-2">AI Photo Studio</h1>
            <p id="main-subtitle" class="text-lg text-gray-600">Ch·ªçn c√¥ng c·ª• s√°ng t·∫°o c·ªßa b·∫°n</p>
        </header>
        
        <div id="selectionScreen">
            <div class="flex flex-wrap justify-center gap-8 max-w-7xl mx-auto">
                <div id="selectGenerator" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                    <div class="text-6xl mb-4">üé®</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Tr√¨nh T·∫°o ·∫¢nh AI</h2>
                    <p class="text-gray-600">T·∫°o ·∫£nh m·ªõi t·ª´ ƒë·∫ßu v·ªõi nhi·ªÅu b∆∞·ªõc t√πy ch·ªânh chi ti·∫øt: ch·ªçn d√°ng, ki·ªÉu t√≥c, phong c√°ch...</p>
                </div>
                <div id="selectAlbumCreator" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                     <div class="text-6xl mb-4">üì∏</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">T·∫°o Album t·ª´ 1 ·∫¢nh</h2>
                    <p class="text-gray-600">T·∫£i l√™n m·ªôt ·∫£nh b·∫°n ∆∞ng √Ω, AI s·∫Ω t·ª± ƒë·ªông t·∫°o ra 7 bi·∫øn th·ªÉ v·ªõi c√°c g√≥c ch·ª•p v√† d√°ng ƒë·ª©ng kh√°c nhau.</p>
                </div>
                <div id="selectWatermarkTool" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                    <div class="text-6xl mb-4">üñãÔ∏è</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">ƒê√≥ng D·∫•u H√†ng Lo·∫°t</h2>
                    <p class="text-gray-600">Th√™m logo v√† m√£ s·∫£n ph·∫©m v√†o nhi·ªÅu ·∫£nh c√πng l√∫c.</p>
                </div>
                 <div id="selectStylistTool" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                    <div class="text-6xl mb-4">‚ú®</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">AI Ph·ªëi ƒê·ªì</h2>
                    <p class="text-gray-600">T√°ch trang ph·ª•c t·ª´ ·∫£nh v√† t·ª± ƒë·ªông ph·ªëi v·ªõi c√°c ph·ª• ki·ªán th·ªùi trang.</p>
                </div>
                <div id="selectFestivalTool" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                     <div class="text-6xl mb-4">üèÆ</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">L·ªÖ H·ªôi Vi·ªát Nam</h2>
                    <p class="text-gray-600">H√≤a m√¨nh v√†o kh√¥ng kh√≠ l·ªÖ h·ªôi truy·ªÅn th·ªëng Vi·ªát Nam v·ªõi trang ph·ª•c b·∫°n ch·ªçn.</p>
                </div>
                 <div id="selectLookbookTool" class="tool-card cursor-pointer bg-white rounded-xl shadow-lg p-8 text-center">
                     <div class="text-6xl mb-4">üñºÔ∏è</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">AI Ch·ª•p ·∫¢nh S·∫£n Ph·∫©m</h2>
                    <p class="text-gray-600">T·∫°o ·∫£nh s·∫£n ph·∫©m chuy√™n nghi·ªáp (treo m√≥c, tr·∫£i ph·∫≥ng, ma-n∆°-canh) m√† kh√¥ng c·∫ßn ng∆∞·ªùi m·∫´u.</p>
                </div>
            </div>
        </div>

        <main id="generatorTool" class="hidden">
            <button id="backToSelectionFromGenerator" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 1: T·∫£i l√™n ·∫£nh ch√¢n dung</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h3 id="faceUploadTitle1" class="font-semibold mb-2 text-center">·∫¢nh ch√¢n dung 1 (B·∫Øt bu·ªôc):</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="faceImageUpload1" class="hidden" accept="image/*">
                            <div class="flex flex-col items-center space-y-2">
                                <button id="faceUploadButton1" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                    Ch·ªçn ·∫£nh
                                </button>
                                <button id="faceClearButton1" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                    X√≥a ·∫£nh
                                </button>
                            </div>
                            <div class="mt-4 flex items-center justify-center space-x-2">
                                <input type="text" id="faceUrlInput1" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                <button id="faceUrlButton1" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                            </div>
                            <p id="faceFileName1" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="faceImagePreviewContainer1" class="mt-4 hidden">
                            <img id="faceImagePreview1" src="" alt="Face 1 Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                    <div id="faceUploadContainer2" class="hidden">
                        <h3 id="faceUploadTitle2" class="font-semibold mb-2 text-center">·∫¢nh ch√¢n dung 2:</h3>
                        <div id="faceUploadBox2">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="faceImageUpload2" class="hidden" accept="image/*">
                                <div class="flex flex-col items-center space-y-2">
                                    <button id="faceUploadButton2" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                        Ch·ªçn ·∫£nh
                                    </button>
                                    <button id="faceClearButton2" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                        X√≥a ·∫£nh
                                    </button>
                                </div>
                                <div class="mt-4 flex items-center justify-center space-x-2">
                                    <input type="text" id="faceUrlInput2" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                    <button id="faceUrlButton2" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                                </div>
                                <p id="faceFileName2" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                            </div>
                            <div id="faceImagePreviewContainer2" class="mt-4 hidden">
                                <img id="faceImagePreview2" src="" alt="Face 2 Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                            </div>
                        </div>
                        <div id="replacementStatus2" class="hidden text-center p-4 bg-purple-50 rounded-lg">
                             <p class="text-sm text-purple-800 mb-2">ƒê√£ thay th·∫ø b·∫±ng Th·∫ßn th√∫.</p>
                            <label for="beastType2" class="text-sm font-semibold text-gray-700">Nh·∫≠p lo√†i v·∫≠t b·∫°n mu·ªën:</label>
                            <input type="text" id="beastType2" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="V√≠ d·ª•: m√®o tr·∫Øng, s∆∞ t·ª≠, g·∫•u tr√∫c...">
                            <p class="text-xs text-gray-500 mt-1">AI s·∫Ω t·∫°o ra m·ªôt phi√™n b·∫£n kh·ªïng l·ªì c·ªßa lo√†i v·∫≠t n√†y.</p>
                        </div>
                        <div id="childOptions2" class="hidden text-center p-4 bg-blue-50 rounded-lg">
                            <label for="childAge2" class="text-sm font-semibold text-gray-700">Ch·ªçn ƒë·ªô tu·ªïi cho b√©:</label>
                            <select id="childAge2" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <option value="a newborn baby">S∆° sinh (0-12 th√°ng)</option>
                                <option value="a 1-2 year old toddler">1-2 tu·ªïi</option>
                                <option value="a 3-5 year old child" selected>3-5 tu·ªïi</option>
                                <option value="a 6-8 year old child">6-8 tu·ªïi</option>
                                <option value="a 9-12 year old child">9-12 tu·ªïi</option>
                            </select>
                            <label for="childHairStyle2" class="text-sm font-semibold text-gray-700 mt-2 block">Ch·ªçn ki·ªÉu t√≥c cho b√©:</label>
                            <select id="childHairStyle2" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </select>
                        </div>
                        <div class="mt-2 text-center text-xs space-x-2">
                            <span>Ho·∫∑c thay th·∫ø b·∫±ng:</span>
                            <button id="replaceWithChild2" class="text-blue-600 hover:underline p-1 font-semibold">Em b√©</button>
                            <button id="replaceWithBeast2" class="text-purple-600 hover:underline p-1 font-semibold">Th·∫ßn th√∫</button>
                            <button id="revertToPerson2" class="text-gray-600 hover:underline p-1 font-semibold hidden">[H·ªßy]</button>
                        </div>
                    </div>
                    <div id="faceUploadContainer3" class="hidden">
                        <h3 id="faceUploadTitle3" class="font-semibold mb-2 text-center">·∫¢nh ch√¢n dung 3:</h3>
                         <div id="faceUploadBox3">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="faceImageUpload3" class="hidden" accept="image/*">
                                <div class="flex flex-col items-center space-y-2">
                                    <button id="faceUploadButton3" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                        Ch·ªçn ·∫£nh
                                    </button>
                                    <button id="faceClearButton3" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                        X√≥a ·∫£nh
                                    </button>
                                </div>
                                 <div class="mt-4 flex items-center justify-center space-x-2">
                                    <input type="text" id="faceUrlInput3" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                    <button id="faceUrlButton3" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                                </div>
                                <p id="faceFileName3" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                            </div>
                            <div id="faceImagePreviewContainer3" class="mt-4 hidden">
                                <img id="faceImagePreview3" src="" alt="Face 3 Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                            </div>
                        </div>
                        <div id="replacementStatus3" class="hidden text-center p-4 bg-purple-50 rounded-lg">
                             <p class="text-sm text-purple-800 mb-2">ƒê√£ thay th·∫ø b·∫±ng Th·∫ßn th√∫.</p>
                            <label for="beastType3" class="text-sm font-semibold text-gray-700">Nh·∫≠p lo√†i v·∫≠t b·∫°n mu·ªën:</label>
                            <input type="text" id="beastType3" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="V√≠ d·ª•: h·ªï, ph∆∞·ª£ng ho√†ng, r·ªìng...">
                            <p class="text-xs text-gray-500 mt-1">AI s·∫Ω t·∫°o ra m·ªôt phi√™n b·∫£n kh·ªïng l·ªì c·ªßa lo√†i v·∫≠t n√†y.</p>
                        </div>
                        <div id="childOptions3" class="hidden text-center p-4 bg-blue-50 rounded-lg">
                            <label for="childAge3" class="text-sm font-semibold text-gray-700">Ch·ªçn ƒë·ªô tu·ªïi cho b√©:</label>
                            <select id="childAge3" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <option value="a newborn baby">S∆° sinh (0-12 th√°ng)</option>
                                <option value="a 1-2 year old toddler">1-2 tu·ªïi</option>
                                <option value="a 3-5 year old child" selected>3-5 tu·ªïi</option>
                                <option value="a 6-8 year old child">6-8 tu·ªïi</option>
                                <option value="a 9-12 year old child">9-12 tu·ªïi</option>
                            </select>
                            <label for="childHairStyle3" class="text-sm font-semibold text-gray-700 mt-2 block">Ch·ªçn ki·ªÉu t√≥c cho b√©:</label>
                            <select id="childHairStyle3" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </select>
                        </div>
                        <div class="mt-2 text-center text-xs space-x-2">
                            <span>Ho·∫∑c thay th·∫ø b·∫±ng:</span>
                            <button id="replaceWithChild3" class="text-blue-600 hover:underline p-1 font-semibold">Em b√©</button>
                            <button id="replaceWithBeast3" class="text-purple-600 hover:underline p-1 font-semibold">Th·∫ßn th√∫</button>
                            <button id="revertToPerson3" class="text-gray-600 hover:underline p-1 font-semibold hidden">[H·ªßy]</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="memberControl" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto text-center hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">B∆∞·ªõc 2: Th√™m/B·ªõt th√†nh vi√™n</h2>
                <div class="flex justify-center space-x-4">
                    <button id="addMemberButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                        + Th√™m th√†nh vi√™n
                    </button>
                    <button id="removeMemberButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300" disabled>
                        - X√≥a th√†nh vi√™n cu·ªëi
                    </button>
                </div>
            </div>

            <div id="optionalUploadsSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-5xl mx-auto hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 3: Th√™m trang ph·ª•c v√† chi ti·∫øt (T√πy ch·ªçn)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="relative">
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh trang ph·ª•c:</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="outfitImageUpload" class="hidden" accept="image/*">
                            <div class="flex flex-col items-center space-y-2">
                                <button id="outfitUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                    Ch·ªçn ·∫£nh
                                </button>
                                <button id="outfitClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                    X√≥a ·∫£nh
                                </button>
                            </div>
                             <div class="mt-4 flex items-center justify-center space-x-2">
                                <input type="text" id="outfitUrlInput" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                <button id="outfitUrlButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                            </div>
                            <p id="outfitFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="outfitImagePreviewContainer" class="mt-4 hidden">
                            <img id="outfitImagePreview" src="" alt="Outfit Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                    <div class="relative">
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh c·∫≠n ch·∫•t v·∫£i:</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="fabricImageUpload" class="hidden" accept="image/*">
                            <div class="flex flex-col items-center space-y-2">
                                <button id="fabricUploadButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                    Ch·ªçn ·∫£nh V·∫£i
                                </button>
                                <button id="fabricClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                    X√≥a ·∫£nh
                                </button>
                            </div>
                             <div class="mt-4 flex items-center justify-center space-x-2">
                                <input type="text" id="fabricUrlInput" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                <button id="fabricUrlButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                            </div>
                            <p id="fabricFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="fabricImagePreviewContainer" class="mt-4 hidden">
                            <img id="fabricImagePreview" src="" alt="Fabric Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh ph·ª• ki·ªán:</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="accessoryImageUpload" class="hidden" accept="image/*">
                            <div class="flex flex-col items-center space-y-2">
                                <button id="accessoryUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                                    Ch·ªçn ·∫£nh
                                </button>
                                <button id="accessoryClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                                    X√≥a ·∫£nh
                                </button>
                            </div>
                             <div class="mt-4 flex items-center justify-center space-x-2">
                                <input type="text" id="accessoryUrlInput" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Ho·∫∑c d√°n link ·∫£nh...">
                                <button id="accessoryUrlButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</button>
                            </div>
                            <p id="accessoryFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="accessoryImagePreviewContainer" class="mt-4 hidden">
                            <img id="accessoryImagePreview" src="" alt="Accessory Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                </div>
            </div>

            <div id="ratioSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 4: Ch·ªçn t·ªâ l·ªá khung h√¨nh</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div id="ratio-1-1" class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-id="ratio-1-1" data-prompt="square, 1:1 aspect ratio">
                        <span class="text-5xl">‚óªÔ∏è</span>
                        <p class="font-semibold mt-2">1:1 (Vu√¥ng)</p>
                    </div>
                    <div id="ratio-9-16" class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-id="ratio-9-16" data-prompt="vertical, phone screen format, 9:16 aspect ratio">
                        <span class="text-5xl">üì±</span>
                        <p class="font-semibold mt-2">9:16 (D·ªçc)</p>
                    </div>
                    <div id="ratio-16-9" class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-id="ratio-16-9" data-prompt="landscape, cinematic, 16:9 aspect ratio">
                        <span class="text-5xl">üñ•Ô∏è</span>
                        <p class="font-semibold mt-2">16:9 (Ngang)</p>
                    </div>
                </div>
            </div>
            
            <div id="bodySelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 5: Ch·ªçn v√≥c d√°ng</h2>
                <div id="bodyGrid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-4 gap-4 md:gap-6">
                    </div>
            </div>

            <div id="hairstyleSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 6: Ch·ªçn ki·ªÉu t√≥c</h2>
                <div id="hairstyleGrid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4 md:gap-6">
                    </div>
            </div>

            <div id="shotTypeSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 7: Ch·ªçn g√≥c ch·ª•p</h2>
                <div id="shotTypeGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 md:gap-6">
                    </div>
            </div>
            
            <div id="dressLengthSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 8: Ch·ªçn ƒë·ªô d√†i v√°y (n·∫øu c√≥ ·∫£nh trang ph·ª•c)</h2>
                <div id="dressLengthGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    </div>
            </div>

            <div id="customDetailsSection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 9: Th√™m chi ti·∫øt t√πy ch·ªânh (T√πy ch·ªçn)</h2>
                <textarea id="customDetailsInput" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="V√≠ d·ª•: ƒëeo k√≠nh r√¢m, c·∫ßm m·ªôt ly c√† ph√™, h·∫≠u c·∫£nh c√≥ hoa anh ƒë√†o..."></textarea>
            </div>

            <div id="themeSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 10: Ch·ªçn phong c√°ch</h2>
                <div id="themeGrid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4 md:gap-6">
                </div>
            </div>

            <div id="colorSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 11: Ch·ªçn t√¥ng m√†u</h2>
                <div id="colorGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 md:gap-6">
                </div>
            </div>

            <div id="resolutionSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 12: Ch·ªçn ch·∫•t l∆∞·ª£ng ·∫£nh</h2>
                <div id="resolutionGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 md:gap-6">
                </div>
            </div>

            <div id="generateAction" class="text-center mb-8 hidden">
                <button id="generateButton" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-10 rounded-lg transition duration-300 text-xl shadow-lg">T·∫°o ·∫£nh ngay!</button>
            </div>
            
            <div id="resultsContainer" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">K·∫øt qu·∫£</h2>
                <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                </div>
            </div>
        </main>

        <main id="albumTool" class="hidden">
            <button id="backToSelectionFromAlbum" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 1: T·∫£i l√™n m·ªôt ·∫£nh b·∫°n th√≠ch</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center max-w-md mx-auto">
                    <input type="file" id="albumSourceImageUpload" class="hidden" accept="image/*">
                    <button id="albumSourceUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh</button>
                    <button id="albumSourceClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">X√≥a ·∫£nh</button>
                    <p id="albumSourceFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                </div>
                <div id="albumSourceImagePreviewContainer" class="mt-4 hidden text-center">
                    <img id="albumSourceImagePreview" src="" alt="Album Source Preview" class="max-w-full h-auto max-h-72 rounded-lg shadow-md mx-auto">
                </div>
            </div>

            <div id="albumActionSection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto text-center hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">B∆∞·ªõc 2: Ch·ªçn lo·∫°i Album</h2>
                <p class="text-gray-600 mb-6">AI s·∫Ω gi·ªØ l·∫°i c√°c y·∫øu t·ªë ch√≠nh v√† t·∫°o ra c√°c bi·∫øn th·ªÉ m·ªõi.</p>
                <div class="flex justify-center space-x-4">
                    <button id="generateAlbumWithModelBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300">T·∫°o Album (c√≥ ng∆∞·ªùi m·∫´u)</button>
                    <button id="generateAlbumProductBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300">T·∫°o Album (s·∫£n ph·∫©m)</button>
                </div>
            </div>

            <div id="albumResultsContainer" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">K·∫øt qu·∫£ Album</h2>
                <div id="albumResultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                </div>
            </div>
        </main>

        <main id="watermarkTool" class="hidden">
            <button id="backToSelectionFromWatermark" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-1/3 bg-white p-6 rounded-2xl shadow-lg h-full">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2">1. T·∫£i ·∫£nh ch√≠nh</h3>
                            <label for="productImage" class="block w-full text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer">
                                <span>Nh·∫•n ƒë·ªÉ ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu ·∫£nh</span>
                                <input type="file" id="productImage" class="hidden" accept="image/*" multiple>
                            </label>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2">2. Th√™m Logo</h3>
                            <label for="logoImage" class="block w-full text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer">
                                <span>Nh·∫•n ƒë·ªÉ ch·ªçn logo</span>
                                <input type="file" id="logoImage" class="hidden" accept="image/*">
                            </label>
                            <div class="mt-4 space-y-3" id="logoControls" style="display: none;">
                                <label for="logoOpacity" class="block text-sm font-medium">ƒê·ªô m·ªù Logo:</label>
                                <input type="range" id="logoOpacity" min="0" max="1" step="0.05" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <label for="logoSize" class="block text-sm font-medium">K√≠ch th∆∞·ªõc Logo:</label>
                                <input type="range" id="logoSize" min="10" max="800" step="5" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2">3. Th√™m M√£ S·∫£n Ph·∫©m</h3>
                            <input type="text" id="productCode" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <div class="mt-4 space-y-4" id="textControls" style="display: none;">
                                <div>
                                    <label for="textFont" class="block text-sm font-medium mb-1">Ph√¥ng ch·ªØ:</label>
                                    <select id="textFont" class="w-full p-2 border border-gray-300 rounded-md">
                                        <option value="Inter" style="font-family: 'Inter'">Inter (M·∫∑c ƒë·ªãnh)</option>
                                        <option value="Roboto" style="font-family: 'Roboto'">Roboto</option>
                                        <option value="Lobster" style="font-family: 'Lobster'">Lobster</option>
                                        <option value="Pacifico" style="font-family: 'Pacifico'">Pacifico</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Verdana">Verdana</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="textColor" class="block text-sm font-medium">M√†u ch·ªØ:</label>
                                        <input type="color" id="textColor" value="#FFFFFF" class="w-full h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="textBgColor" class="block text-sm font-medium">M√†u n·ªÅn ch·ªØ:</label>
                                        <input type="color" id="textBgColor" value="#000000" class="w-full h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                                    </div>
                                </div>
                                 <div>
                                    <label for="textSize" class="block text-sm font-medium">C·ª° ch·ªØ: <span id="textSizeValue">30</span>px</label>
                                    <input type="range" id="textSize" min="8" max="150" step="2" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                 </div>
                                 <div>
                                    <label for="textOpacity" class="block text-sm font-medium">ƒê·ªô m·ªù: <span id="textOpacityValue">100</span>%</label>
                                    <input type="range" id="textOpacity" min="0" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                 </div>
                                <div>
                                    <label for="textPaddingX" class="block text-sm font-medium">ƒê·ªám ngang: <span id="textPaddingXValue">10</span>px</label>
                                    <input type="range" id="textPaddingX" min="0" max="100" step="1" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label for="textPaddingY" class="block text-sm font-medium">ƒê·ªám d·ªçc: <span id="textPaddingYValue">5</span>px</label>
                                    <input type="range" id="textPaddingY" min="0" max="100" step="1" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label for="textBorderRadius" class="block text-sm font-medium">Bo g√≥c: <span id="textBorderRadiusValue">0</span>px</label>
                                    <input type="range" id="textBorderRadius" min="0" max="100" step="1" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                 <div>
                                     <label class="block text-sm font-medium mb-1">CƒÉn ch·ªânh ch·ªØ:</label>
                                     <div class="grid grid-cols-2 gap-4">
                                         <div>
                                             <span class="text-xs text-gray-500">Ngang</span>
                                             <div class="isolate inline-flex rounded-md shadow-sm w-full mt-1">
                                                 <button type="button" data-align-h="left" class="align-h-btn relative inline-flex items-center justify-center rounded-l-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">Tr√°i</button>
                                                 <button type="button" data-align-h="center" class="align-h-btn relative -ml-px inline-flex items-center justify-center px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">Gi·ªØa</button>
                                                 <button type="button" data-align-h="right" class="align-h-btn relative -ml-px inline-flex items-center justify-center rounded-r-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">Ph·∫£i</button>
                                             </div>
                                         </div>
                                         <div>
                                             <span class="text-xs text-gray-500">D·ªçc</span>
                                             <div class="isolate inline-flex rounded-md shadow-sm w-full mt-1">
                                                 <button type="button" data-align-v="top" class="align-v-btn relative inline-flex items-center justify-center rounded-l-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">Tr√™n</button>
                                                 <button type="button" data-align-v="middle" class="align-v-btn relative -ml-px inline-flex items-center justify-center px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">Gi·ªØa</button>
                                                 <button type="button" data-align-v="bottom" class="align-v-btn relative -ml-px inline-flex items-center justify-center rounded-r-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 w-full">D∆∞·ªõi</button>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2">4. T·∫£i Xu·ªëng</h3>
                            <button id="downloadBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                T·∫£i T·∫•t C·∫£ ·∫¢nh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="lg:w-2/3 flex flex-col gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-lg flex-grow flex items-center justify-center min-h-[400px]">
                        <div id="canvas-container" class="relative w-full h-full custom-scrollbar overflow-auto">
                             <canvas id="canvas"></canvas>
                            <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
                                <p>Vui l√≤ng t·∫£i ·∫£nh s·∫£n ph·∫©m ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                        </div>
                    </div>
                     <div id="thumbnail-container" class="bg-white p-4 rounded-2xl shadow-lg" style="display: none;">
                        <div id="thumbnail-gallery" class="flex gap-3 overflow-x-auto custom-scrollbar pb-2">
                            </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="stylistTool" class="hidden">
            <button id="backToSelectionFromStylist" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>
            <div id="stylistUploadSection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 1: T·∫£i l√™n ·∫£nh trang ph·ª•c</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh g·ªëc (c√≥ ng∆∞·ªùi m·∫´u):</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="stylistSourceImageUpload" class="hidden" accept="image/*">
                            <button id="stylistSourceUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh</button>
                            <button id="stylistSourceClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">X√≥a ·∫£nh</button>
                            <p id="stylistSourceFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="stylistSourceImagePreviewContainer" class="mt-4 hidden">
                            <img id="stylistSourceImagePreview" src="" alt="Stylist Source Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh c·∫≠n ch·∫•t v·∫£i (t√πy ch·ªçn):</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="stylistFabricImageUpload" class="hidden" accept="image/*">
                            <button id="stylistFabricUploadButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh V·∫£i</button>
                            <button id="stylistFabricClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">X√≥a ·∫£nh</button>
                            <p id="stylistFabricFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="stylistFabricImagePreviewContainer" class="mt-4 hidden">
                            <img id="stylistFabricImagePreview" src="" alt="Stylist Fabric Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                </div>
            </div>
            <div id="stylistActionSection" class="hidden text-center mb-8">
                <button id="generateStyledSetButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg">T·∫°o b·ªô ph·ªëi ƒë·ªì</button>
            </div>
            <div id="stylistResultsContainer" class="hidden max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">K·∫øt qu·∫£ ph·ªëi ƒë·ªì</h2>
                    <button id="stylistResetButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">B·∫Øt ƒë·∫ßu l·∫°i</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-1">
                        <h3 class="font-semibold text-center mb-2">·∫¢nh G·ªëc</h3>
                        <img id="stylistOriginalImageDisplay" src="" alt="Original Outfit" class="rounded-xl shadow-lg w-full">
                    </div>
                    <div class="md:col-span-3">
                        <div id="stylistResultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="festivalTool" class="hidden">
            <button id="backToSelectionFromFestival" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 1: T·∫£i l√™n ·∫£nh</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh ch√¢n dung (B·∫Øt bu·ªôc):</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="festivalFaceImageUpload" class="hidden" accept="image/*">
                            <button id="festivalFaceUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh</button>
                             <p id="festivalFaceFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="festivalFaceImagePreviewContainer" class="mt-4 hidden">
                            <img id="festivalFaceImagePreview" src="" alt="Festival Face Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-center">·∫¢nh trang ph·ª•c (B·∫Øt bu·ªôc):</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="festivalOutfitImageUpload" class="hidden" accept="image/*">
                            <button id="festivalOutfitUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh</button>
                             <p id="festivalOutfitFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                         <div id="festivalOutfitImagePreviewContainer" class="mt-4 hidden">
                            <img id="festivalOutfitImagePreview" src="" alt="Festival Outfit Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                </div>
            </div>

            <div id="festivalSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 2: Ch·ªçn L·ªÖ h·ªôi b·∫°n mu·ªën tham gia</h2>
                <div id="festivalGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-4 md:gap-6">
                    </div>
            </div>

             <div id="festivalResultsContainer" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">K·∫øt qu·∫£ L·ªÖ h·ªôi</h2>
                <div id="festivalResultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                </div>
            </div>
        </main>
        
        <main id="lookbookTool" class="hidden">
            <button id="backToSelectionFromLookbook" class="mb-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Quay l·∫°i ch·ªçn c√¥ng c·ª•</button>

            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">B∆∞·ªõc 1: T·∫£i l√™n ·∫£nh s·∫£n ph·∫©m</h2>
                <p class="text-center text-sm text-gray-500 mb-4">T·∫£i l√™n ·∫£nh s·∫£n ph·∫©m c·ªßa b·∫°n (ƒë√£ t√°ch n·ªÅn ho·∫∑c tr√™n n·ªÅn tr∆°n).</p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center max-w-md mx-auto">
                    <input type="file" id="lookbookSourceImageUpload" class="hidden" accept="image/*">
                    <button id="lookbookSourceUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh</button>
                    <button id="lookbookSourceClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">X√≥a ·∫£nh</button>
                    <p id="lookbookSourceFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                </div>
                <div id="lookbookSourceImagePreviewContainer" class="mt-4 hidden text-center">
                    <img id="lookbookSourceImagePreview" src="" alt="Lookbook Source Preview" class="max-w-full h-auto max-h-72 rounded-lg shadow-md mx-auto">
                </div>
            </div>

            <div id="lookbookRatioSelection" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 2: Ch·ªçn t·ªâ l·ªá khung h√¨nh</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-prompt="square, 1:1 aspect ratio">
                        <span class="text-5xl">‚óªÔ∏è</span>
                        <p class="font-semibold mt-2">1:1 (Vu√¥ng)</p>
                    </div>
                    <div class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-prompt="portrait, 3:4 aspect ratio">
                        <span class="text-5xl">üìÑ</span>
                        <p class="font-semibold mt-2">3:4 (Lookbook)</p>
                    </div>
                    <div class="aspect-ratio-card border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" data-prompt="vertical, phone screen format, 9:16 aspect ratio">
                        <span class="text-5xl">üì±</span>
                        <p class="font-semibold mt-2">9:16 (Story)</p>
                    </div>
                </div>
            </div>

            <div id="lookbookStyleCreation" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">B∆∞·ªõc 3: Cung c·∫•p B·ªëi c·∫£nh & Phong c√°ch Tham chi·∫øu</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h3 class="font-semibold mb-2 text-center">T√πy ch·ªçn A: M√¥ t·∫£ b·∫±ng vƒÉn b·∫£n</h3>
                        <p class="text-center text-sm text-gray-500 mb-4">
                            M√¥ t·∫£ chi ti·∫øt b·ªëi c·∫£nh, ƒë·∫°o c·ª•, √°nh s√°ng b·∫°n mu·ªën.
                            <br>V√≠ d·ª•: "s·∫£n ph·∫©m treo tr√™n m√≥c g·ªó, n·ªÅn t∆∞·ªùng b√™ t√¥ng, c√≥ ch·∫≠u c√¢y nh·ªè b√™n c·∫°nh, √°nh n·∫Øng chi·∫øu xi√™n."
                        </p>
                        <textarea id="lookbookCustomPrompt" class="w-full p-2 border border-gray-300 rounded-md" rows="5" placeholder="Nh·∫≠p m√¥ t·∫£ c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-center">T√πy ch·ªçn B: D√πng ·∫£nh tham chi·∫øu</h3>
                         <p class="text-center text-sm text-gray-500 mb-4">
                            T·∫£i l√™n m·ªôt ·∫£nh c√≥ phong c√°ch, b·ªë c·ª•c, √°nh s√°ng b·∫°n th√≠ch. AI s·∫Ω ƒë·∫∑t s·∫£n ph·∫©m c·ªßa b·∫°n v√†o ƒë√≥.
                        </p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="lookbookReferenceImageUpload" class="hidden" accept="image/*">
                            <button id="lookbookReferenceUploadButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ch·ªçn ·∫£nh tham chi·∫øu</button>
                            <button id="lookbookReferenceClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 hidden">X√≥a ·∫£nh</button>
                            <p id="lookbookReferenceFileName" class="text-gray-500 mt-2 text-sm">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                        </div>
                        <div id="lookbookReferenceImagePreviewContainer" class="mt-4 hidden text-center">
                            <img id="lookbookReferenceImagePreview" src="" alt="Lookbook Reference Preview" class="max-w-full h-auto max-h-48 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <p class="text-sm text-gray-600 mb-4">M·ªói l·∫ßn b·∫•m n√∫t s·∫Ω t·∫°o ra m·ªôt ·∫£nh duy nh·∫•t v√†o b·ªô s∆∞u t·∫≠p b√™n d∆∞·ªõi.</p>
                    <button id="addLookbookImageButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg">
                        + Th√™m ·∫£nh v√†o b·ªô s∆∞u t·∫≠p
                    </button>
                </div>
            </div>
            
            <div id="lookbookResultsContainer" class="hidden">
                 <div class="flex justify-between items-center mb-6 max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-700">B·ªô s∆∞u t·∫≠p c·ªßa b·∫°n</h2>
                    <button id="clearLookbookResultsButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">X√≥a t·∫•t c·∫£</button>
                </div>
                <div id="lookbookResultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                </div>
            </div>
        </main>
        
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative max-w-2xl mx-auto mt-8" role="alert">
            <strong class="font-bold">√îi, c√≥ l·ªói!</strong>
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>ƒê∆∞·ª£c t·∫°o b·ªüi Google AI & SANG TR∆Ø∆†NG BEMINE</p>
        </footer>
    </div>

    <div id="zoomModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-2 rounded-lg max-w-4xl max-h-full relative">
            <img id="zoomedImage" src="" alt="Zoomed Image" class="max-w-full max-h-[90vh] object-contain">
            <button id="closeModal" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 leading-none">&times;</button>
        </div>
    </div>
    
    <script>
    // Kh√≥a API c·ªßa b·∫°n (ƒê√£ ch√®n: AIzaSyChC-JcLoNCLuogf0J_wBSau2GXNciPfQw)
    const MY_API_KEY = "AIzaSyChC-JcLoNCLuogf0J_wBSau2GXNciPfQw";

    document.addEventListener('DOMContentLoaded', () => {
        // --- Main Navigation ---
        const selectionScreen = document.getElementById('selectionScreen');
        const generatorTool = document.getElementById('generatorTool');
        const albumTool = document.getElementById('albumTool');
        const festivalTool = document.getElementById('festivalTool');
        const stylistTool = document.getElementById('stylistTool');
        const lookbookTool = document.getElementById('lookbookTool');
        const watermarkTool = document.getElementById('watermarkTool');
        const mainTitle = document.getElementById('main-title');
        const mainSubtitle = document.getElementById('main-subtitle');

        const selectGeneratorBtn = document.getElementById('selectGenerator');
        const selectAlbumCreatorBtn = document.getElementById('selectAlbumCreator');
        const selectWatermarkToolBtn = document.getElementById('selectWatermarkTool');
        const selectFestivalToolBtn = document.getElementById('selectFestivalTool');
        const selectStylistToolBtn = document.getElementById('selectStylistTool');
        const selectLookbookToolBtn = document.getElementById('selectLookbookTool');
        
        const backToSelectionFromGeneratorBtn = document.getElementById('backToSelectionFromGenerator');
        const backToSelectionFromAlbumBtn = document.getElementById('backToSelectionFromAlbum');
        const backToSelectionFromWatermarkBtn = document.getElementById('backToSelectionFromWatermark');
        const backToSelectionFromFestivalBtn = document.getElementById('backToSelectionFromFestival');
        const backToSelectionFromStylistBtn = document.getElementById('backToSelectionFromStylist');
        const backToSelectionFromLookbookBtn = document.getElementById('backToSelectionFromLookbook');

        function showScreen(screen, customTitle = null, customSubtitle = null) {
            // Hide all tool screens
            [selectionScreen, generatorTool, albumTool, festivalTool, stylistTool, lookbookTool, watermarkTool].forEach(s => {
                if (s) s.classList.add('hidden');
            });
            // Show the target screen
            if (screen) screen.classList.remove('hidden');

            const screenMap = {
                [generatorTool.id]: { title: 'Tr√¨nh T·∫°o ·∫¢nh AI', subtitle: 'Bi·∫øn m·ªôt b·ª©c ·∫£nh ch√¢n dung th√†nh v√¥ v√†n phong c√°ch s·ªëng ƒë·ªông!' },
                [albumTool.id]: { title: 'T·∫°o Album t·ª´ m·ªôt ·∫¢nh', subtitle: 'Bi·∫øn m·ªôt kho·∫£nh kh·∫Øc th√†nh m·ªôt b·ªô s∆∞u t·∫≠p ƒëa d·∫°ng.' },
                [watermarkTool.id]: { title: 'Tr√¨nh ƒê√≥ng D·∫•u ·∫¢nh H√†ng Lo·∫°t', subtitle: 'Th√™m logo v√† m√£ s·∫£n ph·∫©m v√†o nhi·ªÅu ·∫£nh c√πng l√∫c.' },
                [festivalTool.id]: { title: 'L·ªÖ H·ªôi Vi·ªát Nam', subtitle: 'H√≤a m√¨nh v√†o kh√¥ng kh√≠ l·ªÖ h·ªôi truy·ªÅn th·ªëng Vi·ªát Nam.' },
                [stylistTool.id]: { title: 'AI Ph·ªëi ƒê·ªì', subtitle: 'T√°ch trang ph·ª•c v√† nh·∫≠n g·ª£i √Ω ph·ªëi ƒë·ªì t·ª´ AI.' },
                [lookbookTool.id]: { title: 'AI Ch·ª•p ·∫¢nh S·∫£n Ph·∫©m', subtitle: 'T·∫°o ·∫£nh s·∫£n ph·∫©m chuy√™n nghi·ªáp kh√¥ng c·∫ßn ng∆∞·ªùi m·∫´u.' },
                [selectionScreen.id]: { title: 'AI Photo Studio', subtitle: 'Ch·ªçn c√¥ng c·ª• s√°ng t·∫°o c·ªßa b·∫°n' }
            };

            const info = screenMap[screen.id] || { title: 'AI Photo Studio', subtitle: 'Ch·ªçn c√¥ng c·ª• s√°ng t·∫°o c·ªßa b·∫°n' };
            mainTitle.textContent = customTitle || info.title;
            mainSubtitle.textContent = customSubtitle || info.subtitle;
        }
        
        selectGeneratorBtn.addEventListener('click', () => showScreen(generatorTool));
        selectAlbumCreatorBtn.addEventListener('click', () => showScreen(albumTool));
        selectWatermarkToolBtn.addEventListener('click', () => showScreen(watermarkTool));
        selectFestivalToolBtn.addEventListener('click', () => showScreen(festivalTool));
        selectStylistToolBtn.addEventListener('click', () => showScreen(stylistTool));
        selectLookbookToolBtn.addEventListener('click', () => showScreen(lookbookTool));
        
        [backToSelectionFromGeneratorBtn, backToSelectionFromAlbumBtn, backToSelectionFromFestivalBtn, backToSelectionFromStylistBtn, backToSelectionFromLookbookBtn, backToSelectionFromWatermarkBtn].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => showScreen(selectionScreen));
            }
        });

        // --- GLOBAL ELEMENTS & HELPERS ---
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const zoomModal = document.getElementById('zoomModal');
        const zoomedImage = document.getElementById('zoomedImage');
        const closeModal = document.getElementById('closeModal');

        function setupImageUpload(inputId, buttonId, clearButtonId, fileNameId, previewContainerId, previewId, onUpload, onClear, urlInputId = null, urlButtonId = null) {
            const fileInput = document.getElementById(inputId);
            const uploadButton = document.getElementById(buttonId);
            const clearButton = clearButtonId ? document.getElementById(clearButtonId) : null;
            const fileNameDisplay = document.getElementById(fileNameId);
            const previewContainer = document.getElementById(previewContainerId);
            const previewImage = document.getElementById(previewId);
            const urlInput = urlInputId ? document.getElementById(urlInputId) : null;
            const urlButton = urlButtonId ? document.getElementById(urlButtonId) : null;

            const processFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    fileNameDisplay.textContent = file.name || 'Image from URL';
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        previewImage.src = imageUrl;
                        previewContainer.classList.remove('hidden');
                        const base64Data = imageUrl.split(',')[1];
                        onUpload(base64Data, file.type);
                        if (clearButton) clearButton.classList.remove('hidden');
                        if (uploadButton) uploadButton.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    showError('Vui l√≤ng ch·ªçn m·ªôt t·ªáp ·∫£nh h·ª£p l·ªá.');
                }
            };
            
            const clearFile = () => {
                fileInput.value = '';
                fileNameDisplay.textContent = 'Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn';
                previewImage.src = '';
                previewContainer.classList.add('hidden');
                if (urlInput) urlInput.value = '';
                if (onClear) onClear();
                if (clearButton) clearButton.classList.add('hidden');
                if (uploadButton) uploadButton.classList.remove('hidden');
            };

            if(uploadButton) uploadButton.addEventListener('click', () => fileInput.click());
            if(fileInput) fileInput.addEventListener('change', (e) => processFile(e.target.files[0]));
            if (clearButton) clearButton.addEventListener('click', clearFile);
            
            if (urlInput && urlButton) {
                urlButton.addEventListener('click', async () => {
                    const url = urlInput.value.trim();
                    if (!url) {
                        showError('Vui l√≤ng nh·∫≠p m·ªôt ƒë∆∞·ªùng d·∫´n URL h·ª£p l·ªá.');
                        return;
                    }
                    try {
                        urlButton.textContent = '...';
                        urlButton.disabled = true;
                        // Use a CORS proxy for fetching external images to avoid CORS issues
                        const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`);
                        if (!response.ok) throw new Error('Ph·∫£n h·ªìi m·∫°ng kh√¥ng ·ªïn.');
                        const blob = await response.blob();
                        const file = new File([blob], url.split('/').pop() || 'image.jpg', { type: blob.type });
                        processFile(file);
                    } catch (error) {
                        showError('Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ URL. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n.');
                        console.error('URL Fetch Error:', error);
                    } finally {
                        urlButton.textContent = 'T·∫£i';
                        urlButton.disabled = false;
                    }
                });
            }
        }
        
        function populateGrid(gridElement, items, cardClass) {
            if (!gridElement) return;
            gridElement.innerHTML = items.map(item => `
                <div class="${cardClass} border-2 border-gray-300 rounded-lg p-4 text-center cursor-pointer" data-id="${item.id}" data-prompt="${item.prompt || ''}">
                    <div class="relative">
                        <h3 class="font-bold text-gray-800">${item.name}</h3>
                        ${item.description ? `<p class="text-xs text-gray-500 mt-1">${item.description}</p><div class="tooltip">${item.description}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function handleSelection(container, cardClass, callback) {
             if (!container) return;
             container.addEventListener('click', (e) => {
                const card = e.target.closest(`.${cardClass}`);
                if (card) {
                    container.querySelectorAll(`.${cardClass}`).forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    callback(card.dataset.prompt, card.dataset.id);
                }
            });
        }


        // --- GENERATOR TOOL ELEMENTS & LOGIC ---
        const faceImageUpload1 = document.getElementById('faceImageUpload1');
        const faceUploadButton1 = document.getElementById('faceUploadButton1');
        const faceClearButton1 = document.getElementById('faceClearButton1');
        const faceFileName1 = document.getElementById('faceFileName1');
        const faceImagePreviewContainer1 = document.getElementById('faceImagePreviewContainer1');
        const faceImagePreview1 = document.getElementById('faceImagePreview1');
        const faceUrlInput1 = document.getElementById('faceUrlInput1');
        const faceUrlButton1 = document.getElementById('faceUrlButton1');
        const faceUploadContainer2 = document.getElementById('faceUploadContainer2');
        const faceUploadBox2 = document.getElementById('faceUploadBox2');
        const faceImageUpload2 = document.getElementById('faceImageUpload2');
        const faceUploadButton2 = document.getElementById('faceUploadButton2');
        const faceClearButton2 = document.getElementById('faceClearButton2');
        const faceFileName2 = document.getElementById('faceFileName2');
        const faceImagePreviewContainer2 = document.getElementById('faceImagePreviewContainer2');
        const faceImagePreview2 = document.getElementById('faceImagePreview2');
        const faceUrlInput2 = document.getElementById('faceUrlInput2');
        const faceUrlButton2 = document.getElementById('faceUrlButton2');
        const replacementStatus2 = document.getElementById('replacementStatus2');
        const replaceWithChild2 = document.getElementById('replaceWithChild2');
        const replaceWithBeast2 = document.getElementById('replaceWithBeast2');
        const revertToPerson2 = document.getElementById('revertToPerson2');
        const faceUploadTitle2 = document.getElementById('faceUploadTitle2');
        const beastTypeInput2 = document.getElementById('beastType2');
        const faceUploadContainer3 = document.getElementById('faceUploadContainer3');
        const faceUploadBox3 = document.getElementById('faceUploadBox3');
        const faceImageUpload3 = document.getElementById('faceImageUpload3');
        const faceUploadButton3 = document.getElementById('faceUploadButton3');
        const faceClearButton3 = document.getElementById('faceClearButton3');
        const faceFileName3 = document.getElementById('faceFileName3');
        const faceImagePreviewContainer3 = document.getElementById('faceImagePreviewContainer3');
        const faceImagePreview3 = document.getElementById('faceImagePreview3');
        const faceUrlInput3 = document.getElementById('faceUrlInput3');
        const faceUrlButton3 = document.getElementById('faceUrlButton3');
        const replacementStatus3 = document.getElementById('replacementStatus3');
        const replaceWithChild3 = document.getElementById('replaceWithChild3');
        const replaceWithBeast3 = document.getElementById('replaceWithBeast3');
        const revertToPerson3 = document.getElementById('revertToPerson3');
        const faceUploadTitle3 = document.getElementById('faceUploadTitle3');
        const beastTypeInput3 = document.getElementById('beastType3');
        const memberControl = document.getElementById('memberControl');
        const addMemberButton = document.getElementById('addMemberButton');
        const removeMemberButton = document.getElementById('removeMemberButton');
        const optionalUploadsSelection = document.getElementById('optionalUploadsSelection');
        const outfitImageUpload = document.getElementById('outfitImageUpload');
        const outfitUploadButton = document.getElementById('outfitUploadButton');
        const outfitClearButton = document.getElementById('outfitClearButton');
        const outfitFileName = document.getElementById('outfitFileName');
        const outfitImagePreviewContainer = document.getElementById('outfitImagePreviewContainer');
        const outfitImagePreview = document.getElementById('outfitImagePreview');
        const outfitUrlInput = document.getElementById('outfitUrlInput');
        const outfitUrlButton = document.getElementById('outfitUrlButton');
        const fabricImageUpload = document.getElementById('fabricImageUpload');
        const fabricUploadButton = document.getElementById('fabricUploadButton');
        const fabricClearButton = document.getElementById('fabricClearButton');
        const fabricFileName = document.getElementById('fabricFileName');
        const fabricImagePreviewContainer = document.getElementById('fabricImagePreviewContainer');
        const fabricImagePreview = document.getElementById('fabricImagePreview');
        const fabricUrlInput = document.getElementById('fabricUrlInput');
        const fabricUrlButton = document.getElementById('fabricUrlButton');
        const accessoryImageUpload = document.getElementById('accessoryImageUpload');
        const accessoryUploadButton = document.getElementById('accessoryUploadButton');
        const accessoryClearButton = document.getElementById('accessoryClearButton');
        const accessoryFileName = document.getElementById('accessoryFileName');
        const accessoryImagePreviewContainer = document.getElementById('accessoryImagePreviewContainer');
        const accessoryImagePreview = document.getElementById('accessoryImagePreview');
        const accessoryUrlInput = document.getElementById('accessoryUrlInput');
        const accessoryUrlButton = document.getElementById('accessoryUrlButton');
        const ratioSelection = document.getElementById('ratioSelection');
        const ratioCards = document.querySelectorAll('.aspect-ratio-card');
        const bodySelection = document.getElementById('bodySelection');
        const bodyGrid = document.getElementById('bodyGrid');
        const hairstyleSelection = document.getElementById('hairstyleSelection');
        const hairstyleGrid = document.getElementById('hairstyleGrid');
        const shotTypeSelection = document.getElementById('shotTypeSelection');
        const shotTypeGrid = document.getElementById('shotTypeGrid');
        const dressLengthSelection = document.getElementById('dressLengthSelection');
        const dressLengthGrid = document.getElementById('dressLengthGrid');
        const themeSelection = document.getElementById('themeSelection');
        const themeGrid = document.getElementById('themeGrid');
        const customDetailsSection = document.getElementById('customDetailsSection');
        const customDetailsInput = document.getElementById('customDetailsInput');
        const colorSelection = document.getElementById('colorSelection');
        const colorGrid = document.getElementById('colorGrid');
        const resolutionSelection = document.getElementById('resolutionSelection');
        const resolutionGrid = document.getElementById('resolutionGrid');
        const generateAction = document.getElementById('generateAction');
        const generateButton = document.getElementById('generateButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsGrid = document.getElementById('resultsGrid');

        // State variables
        let base64FaceData1 = null;
        let base64FaceData2 = null;
        let base64FaceData3 = null;
        let selectedPersonCount = 1;
        let person2Replacement = null; // null, 'child', or 'beast'
        let person3Replacement = null; // null, 'child', or 'beast'
        let beastType2 = '';
        let beastType3 = '';
        let person2AgePrompt = 'a 3-5 year old child'; // Default value
        let person3AgePrompt = 'a 3-5 year old child'; // Default value
        let person2HairPrompt = 'short, soft baby hair'; // Default value
        let person3HairPrompt = 'short, soft baby hair'; // Default value

        let base64OutfitData = null;
        let outfitMimeType = null;
        let base64FabricData = null;
        let fabricMimeType = null;
        let base64AccessoryData = null;
        let selectedRatio = null;
        let selectedRatioPrompt = '';
        let selectedBodyPrompt = null;
        let selectedHairstylePrompt = null;
        let selectedShotTypePrompt = null;
        let selectedDressLengthPrompt = null;
        let selectedTheme = null;
        let selectedColorPrompt = '';
        let selectedResolutionPrompt = '8k resolution, ultra-detailed, photorealistic.';

        const singlePersonPoses = [
            "v·ªõi d√°ng ƒë·ª©ng t·ª± tin v√† n·ª• c∆∞·ªùi nh·∫π nh√†ng",
            "v·ªõi d√°ng ƒëi nƒÉng ƒë·ªông, quay ƒë·∫ßu nh√¨n qua vai",
            "ƒë·ª©ng th∆∞ th√°i, m·ªôt tay ch·ªëng h√¥ng",
            "t·ª±a v√†o t∆∞·ªùng v·ªõi bi·ªÉu c·∫£m tho·∫£i m√°i",
            "v·ªõi v·∫ª ngo√†i t·ª± nhi√™n, nh√¨n nh·∫π sang h∆∞·ªõng kh√°c",
            "v·ªõi √°nh m·∫Øt tinh ngh·ªãch v√† ƒë·∫ßu h∆°i nghi√™ng",
            "ng·ªìi m·ªôt c√°ch duy√™n d√°ng tr√™n gh·∫ø"
        ];

        const groupPoses = [
            "hai ng∆∞·ªùi ƒëang t∆∞∆°ng t√°c t·ª± nhi√™n",
            "ba ng∆∞·ªùi ƒëang tr√≤ chuy·ªán vui v·∫ª",
            "nh√≥m b·∫°n ƒëang t·∫°o d√°ng ch·ª•p ·∫£nh",
            "c·∫£ nh√≥m ƒëang nh√¨n v√†o m√°y ·∫£nh v√† c∆∞·ªùi",
            "ƒë·ª©ng c·∫°nh nhau m·ªôt c√°ch th√¢n thi·∫øt",
            "c√πng nhau ƒëi d·∫°o"
        ];
        
        // --- STEP VISIBILITY LOGIC ---
        function checkAllStepsCompletion() {
            const steps = [
                memberControl, optionalUploadsSelection, ratioSelection, bodySelection, 
                hairstyleSelection, shotTypeSelection, dressLengthSelection, 
                customDetailsSection, themeSelection, colorSelection, resolutionSelection, generateAction
            ];
            steps.forEach(step => { if (step) step.classList.add('hidden') });

            if (!base64FaceData1) return;

            if (memberControl) memberControl.classList.remove('hidden');
            if (optionalUploadsSelection) optionalUploadsSelection.classList.remove('hidden');

            let requiredFacesUploaded = true;
            if (selectedPersonCount >= 2 && person2Replacement !== 'beast' && !base64FaceData2) requiredFacesUploaded = false;
            if (selectedPersonCount >= 3 && person3Replacement !== 'beast' && !base64FaceData3) requiredFacesUploaded = false;

            if (!requiredFacesUploaded) return;

            if (ratioSelection) ratioSelection.classList.remove('hidden');
            if (!selectedRatio) return;

            if (bodySelection) bodySelection.classList.remove('hidden');
            if (selectedBodyPrompt === null) return;

            if (hairstyleSelection) hairstyleSelection.classList.remove('hidden');
            if (selectedHairstylePrompt === null) return;
            
            if (shotTypeSelection) shotTypeSelection.classList.remove('hidden');
            if (selectedShotTypePrompt === null) return;

            if (base64OutfitData) {
                if (dressLengthSelection) dressLengthSelection.classList.remove('hidden');
                if (selectedDressLengthPrompt === null) return;
            }
            
            if (customDetailsSection) customDetailsSection.classList.remove('hidden');
            if (themeSelection) themeSelection.classList.remove('hidden');

            if (selectedTheme) {
                if (colorSelection) colorSelection.classList.remove('hidden');
                if (resolutionSelection) resolutionSelection.classList.remove('hidden');
                if (generateAction) generateAction.classList.remove('hidden');
            }
        }
        
        // --- DATA & SETUP FOR GENERATOR TOOL ---
        const bodyTypes = [
            { id: 'slim', name: 'D√°ng Thon G·ªçn', prompt: 'a slim body type' },
            { id: 'curvy', name: 'ƒê∆∞·ªùng Cong Quy·∫øn R≈©', prompt: 'a curvy, hourglass body type' },
            { id: 'athletic', name: 'D√°ng T·∫≠p Gym', prompt: 'an athletic and toned body type' },
            { id: 'tall', name: 'D√°ng Cao R√°o', prompt: 'a tall and slender body type' },
            { id: 'petite', name: 'D√°ng Nh·ªè Nh·∫Øn', prompt: 'a petite, small-framed body type' },
            { id: 'model', name: 'D√°ng Ng∆∞·ªùi M·∫´u', prompt: 'a tall, slender fashion model body type' },
            { id: 'plus-size', name: 'D√°ng ƒê·∫ßy ƒê·∫∑n', prompt: 'a plus-size, full-figured body type' },
            { id: 'natural-avg', name: 'D√°ng T·ª± Nhi√™n', prompt: 'a natural, average body type' }
        ];

        const babyHairstyles = [
            { id: 'short-soft', name: 'T√≥c T∆° M·ªÅm M·∫°i', prompt: 'short, soft baby hair' },
            { id: 'slightly-curly', name: 'T√≥c XoƒÉn Nh·∫π', prompt: 'slightly curly baby hair' },
            { id: 'top-knot', name: 'B√∫i C·ªß T·ªèi', prompt: 'a cute top-knot hairstyle' },
            { id: 'bowl-cut', name: 'T√≥c B√°t √öp', prompt: 'a simple bowl cut hairstyle' }
        ];

        const hairstyles = [
            { id: 'long-wavy', name: 'T√≥c U·ªën S√≥ng L∆°i', prompt: 'loose wavy hair' },
            { id: 'short-bob', name: 'T√≥c Bob Ngang Vai', prompt: 'a shoulder-length bob hairstyle' },
            { id: 'ponytail', name: 'T√≥c Bu·ªôc ƒêu√¥i Ng·ª±a Th·∫•p', prompt: 'a sleek low ponytail' },
            { id: 'bun', name: 'T√≥c B√∫i Cao G·ªçn G√†ng', prompt: 'an elegant high bun' },
            { id: 'pixie-cut', name: 'T√≥c T√©m Wendy', prompt: 'a soft, layered short hairstyle like Wendy' },
            { id: 'braids', name: 'T√≥c B√∫i N·ª≠a ƒê·∫ßu', prompt: 'a half-up bun hairstyle' },
            { id: 'curly-afro', name: 'T√≥c XoƒÉn Hippie', prompt: 'hippie-style perm with tight curls' },
            { id: 'straight-long', name: 'T√≥c D√†i + M√°i Bay', prompt: 'long, straight hair with wispy bangs' },
            { id: 'hush-cut', name: 'T√≥c Hush Cut', prompt: 'a hush cut hairstyle with soft layers' },
            { id: 'short-layered-bob', name: 'T√≥c Bob Layer Ng·∫Øn', prompt: 'a short, layered bob hairstyle' },
            { id: 'lob-c-curl', name: 'T√≥c Lob U·ªën C√∫p C', prompt: 'a lob hairstyle with C-curl ends' },
            { id: 'hime-cut', name: 'T√≥c Hime Nh·∫≠t B·∫£n', prompt: 'a Japanese Hime cut with blunt sidelocks' },
            { id: 'water-wave', name: 'T√≥c XoƒÉn S√≥ng N∆∞·ªõc', prompt: 'water wave perm hair' },
            { id: 'tomboy-pixie', name: 'T√≥c T√©m Tomboy', prompt: 'a tomboyish pixie cut' },
            { id: 'natra-buns', name: 'T√≥c B√∫i Natra', prompt: 'double buns hairstyle, also known as space buns or Natra buns' },
            { id: 'fishtail-flick', name: 'T√≥c T·ªâa ƒêu√¥i C√°', prompt: 'a layered haircut with flicked-out ends resembling a fishtail' },
            { id: 'french-bangs', name: 'T√≥c M√°i Th∆∞a Ki·ªÉu Ph√°p', prompt: 'French-style see-through bangs' },
            { id: 'mullet-hair', name: 'T√≥c Layer Mullet', prompt: 'a modern mullet hairstyle with layers' }
        ];

        const shotTypes = [
            { id: 'full-shot', name: 'To√†n Th√¢n', prompt: 'full body shot' },
            { id: 'medium-shot', name: 'Trung C·∫£nh', prompt: 'medium shot, from the waist up' },
            { id: 'close-up', name: 'C·∫≠n C·∫£nh', prompt: 'close-up shot, focusing on the face and shoulders' },
            { id: 'cowboy-shot', name: 'G√≥c Cao B·ªìi', prompt: 'cowboy shot, from mid-thigh up' },
            { id: 'portrait', name: 'Ch√¢n Dung', prompt: 'a beautiful portrait shot' }
        ];
        
        const dressLengths = [
            { id: 'default', name: 'Gi·ªØ Nguy√™n G·ªëc', prompt: ''},
            { id: 'mini', name: 'V√°y Ng·∫Øn (Mini)', prompt: 'The outfit is a mini dress/skirt.'},
            { id: 'midi', name: 'V√°y D√†i (Midi)', prompt: 'The outfit is a midi dress/skirt, length below the knee.'},
            { id: 'maxi', name: 'V√°y Ch·∫°m G√≥t (Maxi)', prompt: 'The outfit is a long maxi dress/skirt, reaching the ankles.'}
        ];
        
        const themes = [
            { id: 'selfie-mood', name: '#SelfieMood', en_prompt: ['A casual selfie taken in a cozy, sunlit bedroom.', 'A stylish selfie captured in a cafe with beautiful decor.', 'A selfie taken outdoors in a park on a sunny day.', 'A selfie in front of an interesting mural on a city street.'], description: 'Selfie t·ª± nhi√™n, g√≥c ƒë·∫πp.' },
            { id: 'shopping-mall', name: '#ShoppingMall', en_prompt: ['In a bright, modern shopping mall, posing fashionably near a luxury storefront.', 'On a gleaming escalator inside a bustling, multi-level shopping center.', 'Sitting at a chic cafe inside a high-end shopping mall.', 'In the sunlit atrium of a contemporary shopping complex, surrounded by designer stores.'], description: 'T·∫°i trung t√¢m th∆∞∆°ng m·∫°i.' },
            { id: 'luxury-street', name: '#LuxuryStreet', en_prompt: ['Posing on a luxury shopping street like Rodeo Drive, with high-end brand stores in the background.', 'Strolling down a famous fashion avenue in Milan, window shopping at designer boutiques.', 'On a chic street in Paris, with elegant architecture and luxury shopfronts.'], description: 'Ph·ªë h√†ng hi·ªáu sang ch·∫£nh.' },
            { id: 'mirror-selfie', name: '#MirrorSelfie', en_prompt: ['A stylish mirror selfie in a minimalist bedroom with aesthetic decor.', 'A full-length mirror selfie in an elevator with cool lighting.', 'A mirror selfie in a chic boutique fitting room.', 'Capturing an OOTD in a large, ornate mirror in a vintage-style room.'], description: 'Selfie tr∆∞·ªõc g∆∞∆°ng.' },
            { id: 'ootd', name: '#OOTD', en_prompt: ['A full-body "Outfit of the Day" shot against a clean, urban concrete wall.', 'An OOTD photo taken on a picturesque, quiet city street with charming architecture.', 'Showcasing the outfit in front of a colorful, artistic graffiti wall.', 'An OOTD picture in a minimalist courtyard with clean lines.'], description: 'Khoe trang ph·ª•c h√¥m nay.' },
            { id: 'stay-home-vibes', name: '#StayHomeVibes', en_prompt: ['Cozy and relaxed at home, sitting on a plush sofa near a window with soft, natural light.', 'Reading a book in a comfortable armchair in a quiet corner of a living room.', 'Enjoying a cup of coffee on a beautiful balcony overlooking the city.', 'Chilling on a large, comfortable bed with messy blankets in a bright bedroom.'], description: 'Th∆∞ gi√£n t·∫°i nh√†.' },
            { id: 'aesthetic-room', name: '#AestheticRoom', en_prompt: ['In a beautifully decorated room with lots of green plants, macrame wall hangings, and soft lighting.', 'Posing in a room with aesthetic, minimalist furniture and a neon light sign on the wall.', 'In a room filled with art books, paintings, and a gallery wall.', 'A cozy room with fairy lights, plush textiles, and a dreamy atmosphere.'], description: 'Ph√≤ng decor xinh x·∫Øn.' },
            { id: 'moody-tone', name: '#MoodyTone', en_prompt: ['An atmospheric shot in a dimly lit room, with light coming from a single window, creating deep shadows.', 'A moody photo taken during a rainy day, looking out a window with raindrops on the glass.', 'An emotional portrait in a dark, vintage-inspired setting with dramatic lighting.', 'A photo with deep, cinematic shadows taken in an urban alleyway at dusk.'], description: 'Tone m√†u t√¢m tr·∫°ng, s√¢u l·∫Øng.' },
            { id: 'soft-girl', name: '#SoftGirl', en_prompt: ['A soft girl aesthetic photo in a field of flowers, with dreamy, pastel-colored lighting.', 'A sweet and innocent vibe in a pastel-pink themed bedroom.', 'Posing with a cute prop like a lollipop or a teddy bear in a whimsical, dreamy setting.', 'A soft-focus portrait with a gentle, glowing light, surrounded by light, airy fabrics.'], description: 'N√†ng th∆° ng·ªçt ng√†o.' },
            { id: 'minimal-vibes', name: '#MinimalVibes', en_prompt: ['A minimalist aesthetic shot against a seamless, solid light-gray studio background.', 'A simple composition in front of a clean architectural wall with interesting geometric shadows.', 'A portrait focusing entirely on the subject with a completely blurred, neutral background.', 'A clean shot in an empty, bright room with white walls and a single piece of modern furniture.'], description: 'Phong c√°ch t·ªëi gi·∫£n.' },
            { id: 'daily-vlog', name: '#DailyVlog', en_prompt: ['A candid shot that looks like a still from a daily vlog, captured while shopping for groceries at a farmers market.', 'A vlog-style image, taken while preparing coffee in a bright, modern kitchen.', 'A snapshot from a vlog, showing the person working on a laptop at a cool co-working space.', 'A candid moment from a daily vlog, walking a dog in a city park.'], description: 'Nh∆∞ c·∫Øt t·ª´ vlog.' },
            { id: 'candid-shot', name: '#CandidShot', en_prompt: ['An unposed shot, as if caught in the middle of laughing heartily at a cafe with friends.', 'A natural-looking photo, captured while walking down a busy city street, unaware of the camera.', 'A candid moment of fixing their hair, with a blurred city background.', 'A shot captured while absorbed in looking at artwork in a gallery.'], description: 'Ch·ª•p l√©n t·ª± nhi√™n.' },
            { id: 'in-my-room', name: '#InMyRoom', en_prompt: ['A personal, intimate shot inside a bedroom, sitting on the floor surrounded by books and records.', 'A relaxed photo on the bed, showing personality through posters and decor on the wall.', 'Getting ready in front of a vanity mirror in a cozy, personalized bedroom.'], description: 'Trong ph√≤ng ri√™ng.' },
            { id: 'golden-hour', name: '#GoldenHour', en_prompt: ['Shot during the golden hour on a beach, with warm, magical sunlight creating a beautiful glow on the skin and hair.', 'A golden hour portrait in a city, with the setting sun casting long shadows and creating a warm flare.', 'A magical shot in a field of wheat during the golden hour, with the sun setting behind.'], description: 'D∆∞·ªõi n·∫Øng ho√†ng h√¥n.' },
            { id: 'retro-vintage', name: '#RetroVintage', en_prompt: ['A retro-style photo with film grain, capturing a 70s fashion look on a vintage bicycle.', 'A vintage polaroid-style shot in an old-school diner.', 'A photo with faded colors and light leaks, reminiscent of an old film camera, taken in a record store.'], description: 'Ho√†i c·ªï, vintage.' },
            { id: 'authentic-shot', name: '#AuthenticShot', en_prompt: ['An authentic, raw portrait with natural lighting, showing real emotion and minimal makeup.', 'A realistic, unposed shot capturing a simple, everyday moment at home.', 'A photo that avoids overly perfect staging, showing a slightly messy but charming real-life background.'], description: 'Ch√¢n th·ª±c, m·ªôc m·∫°c.' },
            { id: 'vivid-colors', name: '#VividColors', en_prompt: ['A photo bursting with vivid colors, taken in front of a brightly painted wall or building.', 'A high-energy shot at a vibrant location like a carnival or a colorful market.', 'A portrait with highly saturated colors, set against a backdrop of bold, contrasting hues.'], description: 'M√†u s·∫Øc s·ªëng ƒë·ªông.' },
            { id: 'cinematic', name: '#Cinematic', en_prompt: ['A cinematic shot with a widescreen feel, in a dramatic setting like an empty train station at night.', 'A storytelling image with moody lighting, as if it is a scene from a mystery film.', 'A beautifully composed wide shot in a breathtaking landscape, with cinematic color grading.'], description: 'Nh∆∞ m·ªôt c·∫£nh phim.' },
            { id: 'motion-blur', name: '#MotionBlur', en_prompt: ['A creative shot using slow shutter speed to create motion blur from city lights at night as the subject stands still.', 'A dynamic photo where the background is blurred due to panning the camera to follow the moving subject.', 'An artistic portrait with intentional camera movement to create abstract light streaks.'], description: 'Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m·ªù.' },
            { id: 'high-contrast-bw', name: '#HighContrastBW', en_prompt: ['A dramatic high-contrast black and white portrait with strong shadows defining the facial features.', 'A B&W street photography shot with deep blacks and bright whites, capturing interesting silhouettes.', 'An architectural photo in black and white, emphasizing strong lines and textures with high contrast.'], description: 'ƒêen tr·∫Øng t∆∞∆°ng ph·∫£n cao.' },
            { id: 'neon', name: '#Neon', en_prompt: ['A portrait taken at night, illuminated by the vibrant pink and blue glow of neon signs in a city like Tokyo or Seoul.', 'A stylish shot in a retro arcade, surrounded by the colorful lights of game machines.', 'A photo taken on a rainy city street at night, with neon lights reflecting on the wet pavement.'], description: 'D∆∞·ªõi √°nh ƒë√®n neon.' },
            { id: 'youthful-office', name: '#C√¥ngS·ªüTr·∫ªTrung', en_prompt: ['A modern and youthful office wear look, in a bright, contemporary open-plan office with glass walls.', 'Posing in a stylish office lounge area with modern furniture and indoor plants.', 'A professional yet chic look, captured in a minimalist office corridor with interesting lighting.'], description: 'C√¥ng s·ªü tr·∫ª trung.' },
            { id: 'vest-skirt-set', name: '#SetVestCh√¢nV√°y', en_prompt: ['A stylish look featuring a matching vest and skirt set, posed on a modern city rooftop with a skyscraper backdrop.', 'Showcasing a vest and skirt set in a chic, minimalist architectural setting with clean lines.', 'A fashion shot of a vest and skirt set on a grand staircase inside a modern building.'], description: 'Set vest v√† ch√¢n v√°y.' },
            { id: 'studio-shot', name: '#Ch·ª•p·∫¢nhStudio', en_prompt: ['A professional studio photoshoot with a seamless white cyclorama background and bright, even lighting.', 'A fashion portrait in a studio with a colored paper background (e.g., pastel blue, deep red) and dramatic lighting.', 'A studio shot using interesting props like geometric blocks or a vintage chair against a neutral background.'], description: 'Ch·ª•p t·∫°i studio.' },
            { id: 'luxury-lookbook', name: '#LookbookSangTr·ªçng', en_prompt: ['A high-fashion lookbook shot in a luxurious, minimalist villa with large windows and a view.', 'A chic and elegant look captured in a location with brutalist or modern architecture.', 'A sophisticated pose in a high-end art gallery, with a neutral and clean aesthetic.'], description: 'Lookbook th·ªùi trang cao c·∫•p.' },
            { id: 'stay-home-mirror-selfie', name: '#StayHome-SelfieG∆∞∆°ng', en_prompt: ['A cozy mirror selfie at home, in front of a full-length mirror leaning against a wall in the bedroom.', 'A stylish selfie captured in a beautifully framed bathroom mirror.', 'A selfie in an antique, ornate mirror in a living room, showing off a relaxed indoor look.'], description: 'Selfie t·∫°i nh√† tr∆∞·ªõc g∆∞∆°ng.' },
            { id: 'paris', name: 'D·∫°o Ph·ªë Paris', en_prompt: ['Strolling on a charming Parisian street with the Eiffel Tower artistically blurred in the background.', 'Sitting at a classic Parisian sidewalk cafe, with a cup of coffee on the table.', 'Posing on a picturesque bridge over the Seine river, with classic Haussmannian buildings in view.', 'Walking through the artistic neighborhood of Montmartre, with its cobblestone streets and quaint shops.'], description: 'L√£ng m·∫°n, c·ªï ƒëi·ªÉn' },
            { id: 'studio-minimal', name: 'Studio T·ªëi Gi·∫£n', en_prompt: ['in a minimalist studio with a solid, seamless light gray background and professional softbox lighting.', 'in a studio with a neutral beige or cream-colored background, with a single, simple prop like a wooden stool.', 'A clean portrait against a pure white background in a professional photo studio, focusing on the fashion.'], description: 'S·∫°ch s·∫Ω, chuy√™n nghi·ªáp' },
            { id: 'cafe', name: 'Qu√°n C√† Ph√™', en_prompt: ['in a cozy coffee shop, sitting by a large window with natural light streaming in.', 'Reading a book at a wooden table in a rustic, industrial-style cafe.', 'Chatting with a friend (out of frame) in a vibrant, bustling coffee shop with lots of character.'], description: 'G·∫ßn g≈©i, ƒë·ªùi th∆∞·ªùng' },
            { id: 'library', name: 'Th∆∞ Vi·ªán C·ªï K√≠nh', en_prompt: ['in a grand, old library with towering, floor-to-ceiling wooden bookshelves.', 'Sitting at a long reading table with a classic green lamp in a historic library.', 'Looking for a book on a rolling ladder in a beautiful, classic library.'], description: 'Tri th·ª©c, thanh l·ªãch' },
            { id: 'art-gallery', name: 'Tri·ªÉn L√£m Ngh·ªá Thu·∫≠t', en_prompt: ['in a modern art gallery, thoughtfully observing a large, colorful abstract painting.', 'Posing stylishly next to a minimalist sculpture in a bright, white-walled gallery.', 'Walking through a contemporary art exhibition with interesting installations in the background.'], description: 'S√°ng t·∫°o, tinh t·∫ø' },
            { id: 'vietnam-countryside', name: 'ƒê·ªìng Qu√™ Vi·ªát Nam', en_prompt: ['in the middle of a lush green rice paddy field in rural Vietnam, wearing a traditional conical hat (n√≥n l√°).', 'Walking along a small village path with buffaloes and traditional houses in the background.', 'Posing by a peaceful lotus pond in the Vietnamese countryside at sunrise.'], description: 'Truy·ªÅn th·ªëng, m·ªôc m·∫°c' },
            { id: 'european-studio', name: 'Studio Ch√¢u √Çu', en_prompt: ['in a luxurious Parisian apartment-style studio with high ceilings, classic wainscoting, a crystal chandelier, and dramatic light streaming through large windows with silk curtains.', 'posing by a grand, ornate marble fireplace in an elegant studio with herringbone floors, cinematic shadows, and antique moldings.', 'in a sophisticated studio resembling a classic European living room, with a deep-colored velvet chaise lounge, rich textiles, and moody, atmospheric lighting.', 'in a sun-drenched conservatory with intricate ironwork architecture, lush tropical plants, mosaic tile floors, and soft, diffused cinematic light.', 'in a rustic Tuscan villa-style studio with textured plaster walls, terracotta floors, heavy wooden beams, and warm, golden hour light coming from an arched window.', 'in a dramatic, minimalist studio with a single, focused spotlight on the subject, set against a backdrop of heavy, dark velvet curtains, creating a high-contrast, film noir look.', 'in an opulent Baroque-style room with gilded mirrors, ornate furniture, and dramatic drapery, with a lighting setup reminiscent of a Vermeer painting.', 'in a classic European library or study, surrounded by floor-to-ceiling dark wood bookshelves, a rolling ladder, with light from a single desk lamp creating a warm, intelligent, and cinematic atmosphere.'], description: 'Sang tr·ªçng, c·ªï ƒëi·ªÉn, v·ªõi n·ªôi th·∫•t ch√¢u √Çu.' },
            { id: 'luxury-european-street', name: 'ƒê∆∞·ªùng Ph·ªë Ch√¢u √Çu', en_prompt: ["A high-fashion street style shot on the chic avenues of Paris, with classic Haussmann architecture in the background.", "A stylish look captured on the cobblestone streets of Milan during fashion week, with a blurred background of luxury boutiques.", "Posing fashionably near a historic landmark in Rome, with a candid, editorial feel.", "A street style photo in London, with an elegant city backdrop and soft, natural lighting."], description: 'Sang tr·ªçng, th·ªùi th∆∞·ª£ng tr√™n ƒë∆∞·ªùng ph·ªë ch√¢u √Çu.' },
            { id: 'teacher-student-mood', name: 'Th·∫ßn Th√°i C√¥ Tr√≤', en_prompt: [ "A candid, natural moment of a Vietnamese teacher leaning down to help a young Vietnamese student one-on-one at their desk, focus on their interaction, not posed.", "A shot from the student's perspective, looking up at a group of young Vietnamese classmates enthusiastically raising their hands, capturing their eager and joyful faces.", "A completely unposed shot of a small group of young Vietnamese students collaborating during a classroom activity, sharing a laugh, completely natural and unaware of the camera.", "A heartwarming shot focusing on a young Vietnamese student's face, lit up with understanding as the teacher explains something, capturing that 'aha' moment.", "A natural light photo of a teacher and a few young Vietnamese students chatting casually on the school steps or a bench during a break, like a stolen, authentic moment.", "An over-the-shoulder shot of a young Vietnamese student, showing their notebook as the teacher points to something, capturing a moment of direct, gentle guidance." ], description: 'B·∫Øt tr·ªçn kho·∫£nh kh·∫Øc t·ª± nhi√™n c·ªßa c√¥ v√† tr√≤.' },
            { id: 'vietnamese-teacher', name: 'C√¥ Gi√°o Vi·ªát Nam', en_prompt: [ 'standing at a lectern in a Vietnamese classroom, teaching a lesson with a green chalkboard in the background.', 'standing gracefully in front of a classroom door, welcoming students with a warm smile.', 'in a sunny schoolyard during break time, with students playing joyfully blurred in the background.', 'in a quiet school library, organizing books on a shelf or reading at a table, looking knowledgeable.', 'in a professional teachers\' meeting room, collaborating with colleagues (out of frame).', 'walking along a sunlit school hallway, with traditional Vietnamese school architecture visible.', 'in a science lab or a practical skills room, demonstrating an experiment, looking focused and intelligent.', 'on the school stage during a ceremony or event, speaking into a microphone with a confident expression.', 'posing elegantly on the school staircase, with light streaming from a nearby window.', 'sitting peacefully on a stone bench in the school garden, under the shade of a large tree, enjoying a quiet moment.' ], description: 'Nhi·ªÅu b·ªëi c·∫£nh tr∆∞·ªùng h·ªçc: b·ª•c gi·∫£ng, s√¢n tr∆∞·ªùng, th∆∞ vi·ªán...' },
            { id: 'mother-child-moment', name: 'Kho·∫£nh Kh·∫Øc M·∫π & B√©', en_prompt: [ "A candid, heartwarming outdoor photo of a mother and her child playing together in a sunny park, laughing naturally.", "A mother and child sharing a gentle moment in a beautiful flower garden, captured with soft, natural light.", "An authentic shot of a mother holding her child's hand while walking along a peaceful beach at sunset.", "A natural, unposed photograph of a mother and child having a picnic on a grassy hill, completely absorbed in their interaction.", "A tender moment between a mother and her child in a rustic countryside setting, like a field or by a quiet lake." ], description: 'B·∫Øt tr·ªçn kho·∫£nh kh·∫Øc t·ª± nhi√™n, t√¨nh c·∫£m c·ªßa hai m·∫π con.' },
            { id: 'mother-child-vietnam', name: 'M·∫π & B√© d·∫°o ch∆°i Vi·ªát Nam', en_prompt: [ "A candid outdoor photo of a mother and child walking hand-in-hand through the ancient town of Hoi An, with yellow walls and lanterns in the background.", "A heartwarming shot of a mother and child on a boat cruise in Ha Long Bay, surrounded by limestone karsts.", "A natural, playful moment between a mother and child on a beautiful beach in Phu Quoc.", "An authentic photo of a mother and her child exploring the Imperial City of Hue.", "A mother and child enjoying a boat trip through the Mekong Delta's lush canals.", "A beautiful photo of a mother and child on the sunny sand dunes of Mui Ne.", "A mother and child enjoying the view from a rice terrace field in Sapa, Vietnam." ], description: 'Ghi l·∫°i kho·∫£nh kh·∫Øc t·ª± nhi√™n c·ªßa m·∫π v√† b√© t·∫°i c√°c danh lam th·∫Øng c·∫£nh Vi·ªát Nam.' },
            { id: 'european-travel', name: 'Du L·ªãch Ch√¢u √Çu', en_prompt: [ "A stylish photo of a Vietnamese person strolling down a charming Parisian street with the Eiffel Tower in the background. The person's original facial features must be perfectly preserved.", "A beautiful shot of a Vietnamese person enjoying the view on the coast of Amalfi, Italy, with colorful houses on the cliffs. The person's original facial features must be perfectly preserved.", "An adventurous photo of a Vietnamese person hiking in the Swiss Alps, surrounded by majestic mountains. The person's original facial features must be perfectly preserved.", "A relaxed photo of a Vietnamese person on a beautiful beach in Santorini, Greece, with iconic white and blue buildings. The person's original facial features must be perfectly preserved.", "A candid shot of a Vietnamese person exploring the historic streets of Prague, Czech Republic. The person's original facial features must be perfectly preserved." ], description: 'Kh√°m ph√° c√°c th√†nh ph·ªë v√† c·∫£nh quan tuy·ªát ƒë·∫πp c·ªßa ch√¢u √Çu.' }
        ];

        const colorOptions = [
            { id: 'default-color', name: 'M·∫∑c ƒë·ªãnh', prompt: '' },
            { id: 'vivid', name: 'M√†u S·∫Øc S·ªëng ƒê·ªông', prompt: 'vivid, saturated colors, high contrast.' },
            { id: 'bw', name: 'ƒêen Tr·∫Øng', prompt: 'dramatic black and white photo.' },
            { id: 'sepia', name: 'T√¥ng N√¢u C·ªï', prompt: 'warm sepia tone, vintage look.' },
            { id: 'pastel', name: 'M√†u Pastel', prompt: 'soft pastel color palette, dreamy aesthetic.' },
            { id: 'moody', name: 'T√¥ng M√†u Tr·∫ßm', prompt: 'moody tones, deep shadows, cinematic color grading.' }
        ];

        const resolutionOptions = [
            { id: 'hd', name: 'HD', prompt: 'high definition, sharp details.' },
            { id: '4k', name: '4K', prompt: '4k resolution, highly detailed.' },
            { id: '8k', name: '8K (M·∫∑c ƒë·ªãnh)', prompt: '8k resolution, ultra-detailed, photorealistic.' },
            { id: 'realistic', name: 'Si√™u Th·ª±c', prompt: 'hyper-realistic, photorealistic.' },
            { id: 'cinematic', name: 'ƒêi·ªán ·∫¢nh', prompt: 'cinematic style, professional color grading, film grain.' }
        ];
        
        // --- GENERATOR TOOL SETUP (RESTORED) ---
        setupImageUpload('faceImageUpload1', 'faceUploadButton1', 'faceClearButton1', 'faceFileName1', 'faceImagePreviewContainer1', 'faceImagePreview1', (data) => { base64FaceData1 = data; checkAllStepsCompletion(); }, () => { base64FaceData1 = null; checkAllStepsCompletion(); }, 'faceUrlInput1', 'faceUrlButton1');
        setupImageUpload('faceImageUpload2', 'faceUploadButton2', 'faceClearButton2', 'faceFileName2', 'faceImagePreviewContainer2', 'faceImagePreview2', (data) => { base64FaceData2 = data; checkAllStepsCompletion(); }, () => { base64FaceData2 = null; checkAllStepsCompletion(); }, 'faceUrlInput2', 'faceUrlButton2');
        setupImageUpload('faceImageUpload3', 'faceUploadButton3', 'faceClearButton3', 'faceFileName3', 'faceImagePreviewContainer3', 'faceImagePreview3', (data) => { base64FaceData3 = data; checkAllStepsCompletion(); }, () => { base64FaceData3 = null; checkAllStepsCompletion(); }, 'faceUrlInput3', 'faceUrlButton3');
        setupImageUpload('outfitImageUpload', 'outfitUploadButton', 'outfitClearButton', 'outfitFileName', 'outfitImagePreviewContainer', 'outfitImagePreview', (data, type) => { base64OutfitData = data; outfitMimeType = type; checkAllStepsCompletion(); }, () => { base64OutfitData = null; outfitMimeType = null; checkAllStepsCompletion(); }, 'outfitUrlInput', 'outfitUrlButton');
        setupImageUpload('fabricImageUpload', 'fabricUploadButton', 'fabricClearButton', 'fabricFileName', 'fabricImagePreviewContainer', 'fabricImagePreview', (data, type) => { base64FabricData = data; fabricMimeType = type; }, () => { base64FabricData = null; fabricMimeType = null; }, 'fabricUrlInput', 'fabricUrlButton');
        setupImageUpload('accessoryImageUpload', 'accessoryUploadButton', 'accessoryClearButton', 'accessoryFileName', 'accessoryImagePreviewContainer', 'accessoryImagePreview', (data) => { base64AccessoryData = data; }, () => { base64AccessoryData = null; }, 'accessoryUrlInput', 'accessoryUrlButton');

        handleSelection(ratioSelection, 'aspect-ratio-card', (prompt, id) => {
            selectedRatio = id;
            selectedRatioPrompt = prompt;
            checkAllStepsCompletion();
        });

        populateGrid(bodyGrid, bodyTypes, 'body-card');
        handleSelection(bodyGrid, 'body-card', (prompt, id) => {
            selectedBodyPrompt = prompt;
            checkAllStepsCompletion();
        });

        populateGrid(hairstyleGrid, hairstyles, 'hairstyle-card');
        handleSelection(hairstyleGrid, 'hairstyle-card', (prompt, id) => {
            selectedHairstylePrompt = prompt;
            checkAllStepsCompletion();
        });
        
        populateGrid(shotTypeGrid, shotTypes, 'shot-type-card');
        handleSelection(shotTypeGrid, 'shot-type-card', (prompt, id) => {
            selectedShotTypePrompt = prompt;
            checkAllStepsCompletion();
        });
        
        populateGrid(dressLengthGrid, dressLengths, 'dress-length-card');
        handleSelection(dressLengthGrid, 'dress-length-card', (prompt, id) => {
             selectedDressLengthPrompt = prompt;
             checkAllStepsCompletion();
        });
        
        populateGrid(themeGrid, themes, 'theme-card');
        
        handleSelection(colorGrid, 'color-card', (prompt, id) => {
            selectedColorPrompt = prompt;
        });

        populateGrid(resolutionGrid, resolutionOptions, 'resolution-card');
        handleSelection(resolutionGrid, 'resolution-card', (prompt, id) => {
            selectedResolutionPrompt = prompt;
        });
        // Select 8K by default
        const defaultResolutionCard = document.querySelector('.resolution-card[data-id="8k"]');
        if (defaultResolutionCard) {
            defaultResolutionCard.classList.add('selected');
        }
        
        if (themeGrid) {
            themeGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.theme-card');
                if (!card) return;
                
                if (!base64FaceData1 || !selectedRatio || !selectedBodyPrompt || !selectedHairstylePrompt || !selectedShotTypePrompt || (base64OutfitData && selectedDressLengthPrompt === null)) {
                    showError("Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√°c b∆∞·ªõc b·∫Øt bu·ªôc (1-8) tr∆∞·ªõc khi ch·ªçn phong c√°ch.");
                    return;
                }

                themeGrid.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedTheme = themes.find(t => t.id === card.dataset.id);
                checkAllStepsCompletion();
            });
        }
        
        if (generateButton) {
            generateButton.addEventListener('click', async () => {
                if (!selectedTheme) {
                    showError("Vui l√≤ng ch·ªçn m·ªôt phong c√°ch ·ªü B∆∞·ªõc 10.");
                    return;
                }

                resultsContainer.classList.remove('hidden');
                resultsGrid.innerHTML = '';
                resultsContainer.scrollIntoView({ behavior: 'smooth' });

                const singlePersonPosesEn = [ "standing confidently with a gentle smile", "walking dynamically, looking over their shoulder", "standing relaxed with one hand on their hip", "leaning against a wall with a comfortable expression", "with a natural look, glancing slightly to the side", "with a playful look and a slight head tilt", "sitting gracefully on a chair" ];
                const groupPosesEn = [ "interacting naturally", "in a joyful conversation", "posing for a photo together", "looking at the camera and smiling", "standing closely together", "walking together" ];

                for (let i = 0; i < 3; i++) {
                    const loadingCardId = `loading-card-${i}`;
                    const loadingCard = `
                        <div id="${loadingCardId}" class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                            <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-[9/16]">
                                 <div>
                                     <div class="loader mx-auto mb-2"></div>
                                     <p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o t∆∞ th·∫ø #${i+1}...</p>
                                </div>
                            </div>
                            <div class="h-5 bg-gray-300 rounded w-1/2 animate-pulse mt-auto"></div>
                        </div>`;
                    resultsGrid.insertAdjacentHTML('beforeend', loadingCard);
                    
                    try {
                        const promptParts = [];

                        // Subject description
                        let subjects = [];
                        const person1Desc = `a person with ${selectedBodyPrompt}, with ${selectedHairstylePrompt}`;
                        subjects.push(person1Desc);

                        if (selectedPersonCount >= 2) {
                            if (person2Replacement === 'child') {
                                subjects.push(`a cute ${person2AgePrompt} with ${person2HairPrompt}`);
                            } else if (person2Replacement === 'beast' && beastTypeInput2.value.trim()) {
                                subjects.push(`a giant ${beastTypeInput2.value.trim()}`);
                            } else {
                                subjects.push(`a second person with ${selectedBodyPrompt}, with ${selectedHairstylePrompt}`);
                            }
                        }
                        if (selectedPersonCount >= 3) {
                            if (person3Replacement === 'child') {
                                subjects.push(`a cute ${person3AgePrompt} with ${person3HairPrompt}`);
                            } else if (person3Replacement === 'beast' && beastTypeInput3.value.trim()) {
                                subjects.push(`a giant ${beastTypeInput3.value.trim()}`);
                            } else {
                                subjects.push(`a third person with ${selectedBodyPrompt}, with ${selectedHairstylePrompt}`);
                            }
                        }
                        
                        let mainSubjectString = subjects[0];
                        if (subjects.length === 2) mainSubjectString = `${subjects[0]} and ${subjects[1]}`;
                        else if (subjects.length > 2) mainSubjectString = subjects.slice(0, -1).join(' and ') + `, and ${subjects.slice(-1)}`; // Correcting grammar here
                        promptParts.push(`An ultra-realistic, high-quality photograph of ${mainSubjectString}.`);

                        // Pose
                        let posePromptEn = selectedPersonCount > 1 
                            ? groupPosesEn[Math.floor(Math.random() * groupPosesEn.length)]
                            : singlePersonPosesEn[Math.floor(Math.random() * singlePersonPosesEn.length)];
                        promptParts.push(`They are ${posePromptEn}.`);
                        
                        // Custom Details
                        if (customDetailsInput.value.trim()) {
                            promptParts.push(`Additional details: ${customDetailsInput.value.trim()}.`);
                        }
                        
                        // Background & Style
                        const randomThemePrompt = Array.isArray(selectedTheme.en_prompt) 
                            ? selectedTheme.en_prompt[Math.floor(Math.random() * selectedTheme.en_prompt.length)]
                            : selectedTheme.en_prompt;
                        promptParts.push(`The setting is ${randomThemePrompt}.`);

                        // Technical Details
                        promptParts.push(`This is a ${selectedShotTypePrompt}.`);
                        promptParts.push(`The style is ${selectedResolutionPrompt}, ${selectedColorPrompt} ${selectedRatioPrompt}.`);

                        if (base64OutfitData && selectedDressLengthPrompt) {
                            promptParts.push(selectedDressLengthPrompt);
                        }
                        
                        // Final instruction
                        let faceInstruction = "The face of the first person in the resulting image MUST BE AN EXACT 1:1 REPLICA of the face in the first provided portrait image.";
                        if (selectedPersonCount >= 2 && person2Replacement !== 'beast' && base64FaceData2) {
                            faceInstruction += " The face of the second person MUST BE AN EXACT 1:1 REPLICA of the face in the second provided portrait image.";
                        }
                        if (selectedPersonCount >= 3 && person3Replacement !== 'beast' && base64FaceData3) {
                            faceInstruction += " The face of the third person MUST BE AN EXACT 1:1 REPLICA of the face in the third provided portrait image.";
                        }
                        promptParts.push(`**CRITICAL INSTRUCTION:** ${faceInstruction}`);

                        if (base64OutfitData) promptParts.push("The character must wear the outfit from the outfit image.");
                        if (base64FabricData) {
                            promptParts.push("**CRITICAL TEXTURE INSTRUCTION:** The texture, pattern, and material of the outfit MUST EXACTLY match the provided close-up fabric image. Use the fabric image as the definitive reference for the outfit's material properties.");
                        }
                        if (base64OutfitData && (person2Replacement === 'child' || person3Replacement === 'child')) {
                            promptParts.push("The child/children in the image should be wearing a child-sized version of the same outfit provided in the outfit image, matching its style and fabric.");
                        }
                        if (base64AccessoryData) promptParts.push("The character must wear/use the accessory from the accessory image.");

                        const finalPrompt = promptParts.filter(p => p && p.trim() !== '').join(' ');
                        
                        // Collect images for API
                        const imagesToApi = [];
                        if (base64FaceData1) imagesToApi.push({ data: base64FaceData1, mimeType: 'image/jpeg' });
                        if (base64FaceData2 && selectedPersonCount >= 2 && person2Replacement !== 'beast') imagesToApi.push({ data: base64FaceData2, mimeType: 'image/jpeg' });
                        if (base64FaceData3 && selectedPersonCount >= 3 && person3Replacement !== 'beast') imagesToApi.push({ data: base64FaceData3, mimeType: 'image/jpeg' });
                        if (base64OutfitData) imagesToApi.push({ data: base64OutfitData, mimeType: outfitMimeType });
                        if (base64FabricData) imagesToApi.push({ data: base64FabricData, mimeType: fabricMimeType });
                        if (base64AccessoryData) imagesToApi.push({ data: base64AccessoryData, mimeType: 'image/png' });

                        const result = await callGeminiApi(finalPrompt, imagesToApi);
                        const candidate = result?.candidates?.[0];
                        const loadingElement = document.getElementById(loadingCardId);

                        if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                            const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const resultCardHTML = `
                                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                    <div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden regenerate-loader z-10 rounded-xl"><div class="loader"></div></div>
                                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[9/16]"><img src="${imageUrl}" alt="${selectedTheme.name} Image ${i + 1}" class="w-full h-full cursor-pointer generated-image object-cover"></div>
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center w-full"><h4 class="font-bold text-lg text-left text-gray-800">${selectedTheme.name} #${i + 1}</h4><a href="${imageUrl}" download="${selectedTheme.id}_${i + 1}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap download-btn">T·∫£i</a></div>
                                        <button class="text-xs text-blue-600 hover:underline mt-1 prompt-toggle-btn">Xem chi ti·∫øt prompt</button>
                                        <button class="text-xs text-indigo-600 hover:underline mt-1 ml-2 edit-btn">Ch·ªânh s·ª≠a & Th√™m chi ti·∫øt</button>
                                        <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded hidden prompt-details break-words">${finalPrompt.replace(/"/g, '&quot;')}</p>
                                        <div class="mt-2 hidden edit-controls"><textarea class="w-full p-2 border rounded-md text-sm edit-prompt-input" rows="2" placeholder="V√≠ d·ª•: th√™m m·ªôt chi·∫øc t√∫i x√°ch m√†u ƒë·ªè..."></textarea><button class="w-full mt-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm regenerate-btn">T·∫°o l·∫°i</button></div>
                                    </div>
                                </div>
                            `;
                            if(loadingElement) {
                                 loadingElement.outerHTML = resultCardHTML;
                                 const newImg = resultsGrid.querySelector(`[alt="${selectedTheme.name} Image ${i + 1}"]`);
                                 if(newImg) newImg.addEventListener('click', (e) => { zoomedImage.src = e.target.src; zoomModal.classList.remove('hidden'); });
                            }
                        } else {
                             if (loadingElement) loadingElement.remove();
                             throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh h·ª£p l·ªá.");
                        }

                    } catch(error) {
                        console.error('Error generating image:', error);
                        const loadingElement = document.getElementById(loadingCardId);
                        if (loadingElement) loadingElement.remove();
                        showError(`L·ªói t·∫°o ·∫£nh: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                    }
                }
            });
        }


        // --- MEMBER MANAGEMENT LOGIC ---
        if (addMemberButton) {
            addMemberButton.addEventListener('click', () => {
                if (selectedPersonCount < 3) {
                    selectedPersonCount++;
                    updateMemberVisibility();
                }
            });
        }

        if (removeMemberButton) {
            removeMemberButton.addEventListener('click', () => {
                if (selectedPersonCount > 1) {
                    selectedPersonCount--;
                    updateMemberVisibility();
                }
            });
        }
        
        function updateMemberVisibility() {
            if (faceUploadContainer2) faceUploadContainer2.classList.toggle('hidden', selectedPersonCount < 2);
            if (faceUploadContainer3) faceUploadContainer3.classList.toggle('hidden', selectedPersonCount < 3);
            if (removeMemberButton) removeMemberButton.disabled = selectedPersonCount <= 1;
            if (addMemberButton) addMemberButton.disabled = selectedPersonCount >= 3;

            let requiredFacesUploaded = true;
            if (selectedPersonCount >= 2 && person2Replacement !== 'beast' && !base64FaceData2) requiredFacesUploaded = false;
            if (selectedPersonCount >= 3 && person3Replacement !== 'beast' && !base64FaceData3) requiredFacesUploaded = false;

            checkAllStepsCompletion();
        }
        
        function setupReplacement(num) {
            const replaceChildBtn = document.getElementById(`replaceWithChild${num}`);
            const replaceBeastBtn = document.getElementById(`replaceWithBeast${num}`);
            const revertBtn = document.getElementById(`revertToPerson${num}`);
            const uploadBox = document.getElementById(`faceUploadBox${num}`);
            const replacementStatus = document.getElementById(`replacementStatus${num}`);
            const title = document.getElementById(`faceUploadTitle${num}`);
            const childOptions = document.getElementById(`childOptions${num}`);
            const childAgeSelect = document.getElementById(`childAge${num}`);
            const childHairSelect = document.getElementById(`childHairStyle${num}`);
            
            if (!replaceChildBtn) return; // Exit if elements don't exist

            replaceChildBtn.addEventListener('click', () => {
                if(num === 2) { person2Replacement = 'child'; title.textContent = '·∫¢nh ch√¢n dung 2 (Em b√©):'; }
                if(num === 3) { person3Replacement = 'child'; title.textContent = '·∫¢nh ch√¢n dung 3 (Em b√©):'; }
                uploadBox.classList.add('hidden');
                replacementStatus.classList.add('hidden');
                childOptions.classList.remove('hidden');
                revertBtn.classList.remove('hidden');
                document.getElementById(`faceClearButton${num}`)?.click();
                checkAllStepsCompletion();
            });

             replaceBeastBtn.addEventListener('click', () => {
                if(num === 2) { person2Replacement = 'beast'; title.textContent = '·∫¢nh ch√¢n dung 2 (Th·∫ßn th√∫):'; }
                if(num === 3) { person3Replacement = 'beast'; title.textContent = '·∫¢nh ch√¢n dung 3 (Th·∫ßn th√∫):'; }
                uploadBox.classList.add('hidden');
                replacementStatus.classList.remove('hidden');
                childOptions.classList.add('hidden');
                revertBtn.classList.remove('hidden');
                 checkAllStepsCompletion();
            });

            revertBtn.addEventListener('click', () => {
                if(num === 2) { person2Replacement = null; title.textContent = '·∫¢nh ch√¢n dung 2:'; }
                if(num === 3) { person3Replacement = null; title.textContent = '·∫¢nh ch√¢n dung 3:'; }
                uploadBox.classList.remove('hidden');
                replacementStatus.classList.add('hidden');
                childOptions.classList.add('hidden');
                revertBtn.classList.add('hidden');
                document.getElementById(`faceClearButton${num}`)?.click();
                 checkAllStepsCompletion();
            });

            if (childAgeSelect) {
                childAgeSelect.addEventListener('change', (e) => {
                    if (num === 2) {
                        person2AgePrompt = e.target.value;
                    } else if (num === 3) {
                        person3AgePrompt = e.target.value;
                    }
                });
            }

            if (childHairSelect) {
                childHairSelect.addEventListener('change', (e) => {
                    if (num === 2) {
                        person2HairPrompt = e.target.value;
                    } else if (num === 3) {
                        person3HairPrompt = e.target.value;
                    }
                });
            }
        }
        setupReplacement(2);
        setupReplacement(3);

        function populateBabyHairDropdowns() {
            const selects = [document.getElementById('childHairStyle2'), document.getElementById('childHairStyle3')];
            selects.forEach(select => {
                if(select) {
                    select.innerHTML = '';
                    babyHairstyles.forEach(style => {
                        const option = new Option(style.name, style.prompt);
                        select.add(option);
                    });
                }
            });
        }
        populateBabyHairDropdowns();

        // --- ALBUM TOOL ---
        const albumSourceImageUpload = document.getElementById('albumSourceImageUpload');
        const albumSourceUploadButton = document.getElementById('albumSourceUploadButton');
        const albumSourceClearButton = document.getElementById('albumSourceClearButton');
        const albumSourceFileName = document.getElementById('albumSourceFileName');
        const albumSourceImagePreviewContainer = document.getElementById('albumSourceImagePreviewContainer');
        const albumSourceImagePreview = document.getElementById('albumSourceImagePreview');
        const albumActionSection = document.getElementById('albumActionSection');
        const generateAlbumWithModelBtn = document.getElementById('generateAlbumWithModelBtn');
        const generateAlbumProductBtn = document.getElementById('generateAlbumProductBtn');
        const albumResultsContainer = document.getElementById('albumResultsContainer');
        const albumResultsGrid = document.getElementById('albumResultsGrid');
        
        let albumSourceBase64 = null;
        let albumSourceMimeType = null;

        const modelAlbumVariations = [
            { id: 'smile_pose', name: 'T·∫°o D√°ng #1: C∆∞·ªùi T∆∞∆°i', prompt: 'A new pose where the person is looking directly at the camera with a warm, genuine smile.' },
            { id: 'look_away_pose', name: 'T·∫°o D√°ng #2: Nh√¨n Xa XƒÉm', prompt: 'A new pose where the person is looking away from the camera, off to the side, with a thoughtful or candid expression.' },
            { id: 'walking_pose', name: 'T·∫°o D√°ng #3: ƒêang B∆∞·ªõc ƒêi', prompt: 'A new dynamic pose, as if the person was captured mid-stride, walking naturally through the scene.' },
            { id: 'close_up_shot', name: 'G√≥c Ch·ª•p #1: C·∫≠n C·∫£nh', prompt: 'A different camera angle. This is a close-up shot focusing on the person\'s face and upper body, capturing their expression in more detail.' },
            { id: 'full_body_shot', name: 'G√≥c Ch·ª•p #2: To√†n Th√¢n', prompt: 'A different camera angle. This is a full-body shot, capturing the entire outfit from head to toe within the existing scene.' },
            { id: 'over_shoulder_shot', name: 'G√≥c Ch·ª•p #3: Nh√¨n Qua Vai', prompt: 'A different camera angle. This is an over-the-shoulder shot, where the person is looking back towards the camera over their shoulder.' },
            { id: 'interactive_pose', name: 'T·∫°o D√°ng #4: T∆∞∆°ng T√°c', prompt: 'A new creative pose where the person is interacting naturally with an element in the background (e.g., leaning against a wall, touching a plant, sitting on a step if available).' }
        ];
        
        if (albumSourceImageUpload) {
            setupImageUpload('albumSourceImageUpload', 'albumSourceUploadButton', 'albumSourceClearButton', 'albumSourceFileName', 'albumSourceImagePreviewContainer', 'albumSourceImagePreview', (data, type) => {
                albumSourceBase64 = data;
                albumSourceMimeType = type;
                if(albumActionSection) albumActionSection.classList.remove('hidden');
            }, () => {
                albumSourceBase64 = null;
                albumSourceMimeType = null;
                if(albumActionSection) albumActionSection.classList.add('hidden');
                if(albumResultsContainer) albumResultsContainer.classList.add('hidden');
                if(albumResultsGrid) albumResultsGrid.innerHTML = '';
            });
        }
        

        async function generateAlbum(isWithModel) {
             if (!albumSourceBase64) {
                showError("Vui l√≤ng t·∫£i l√™n m·ªôt ·∫£nh g·ªëc.");
                return;
            }

            albumResultsContainer.classList.remove('hidden');
            albumResultsGrid.innerHTML = '';
            albumResultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            const originalCard = `
                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[9/16]">
                        <img src="data:${albumSourceMimeType};base64,${albumSourceBase64}" alt="·∫¢nh g·ªëc" class="w-full h-full cursor-pointer generated-image object-cover">
                    </div>
                    <div class="mt-auto">
                        <div class="flex justify-between items-center w-full">
                            <h4 class="font-bold text-lg text-left text-gray-800">·∫¢nh G·ªëc</h4>
                        </div>
                    </div>
                </div>
            `;
            albumResultsGrid.insertAdjacentHTML('beforeend', originalCard);
            const originalImage = albumResultsGrid.querySelector('img[alt="·∫¢nh g·ªëc"]');
            if(originalImage) {
                originalImage.addEventListener('click', (e) => {
                    zoomedImage.src = e.target.src;
                    zoomModal.classList.remove('hidden');
                });
            }
            

            if (isWithModel) {
                const scenarios = modelAlbumVariations;
                for (const scenario of scenarios) {
                    const loadingCardId = `loading-album-${scenario.id}`;
                    const loadingCard = `
                        <div id="${loadingCardId}" class="bg-white p-4 rounded-xl shadow-lg flex flex-col">
                            <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-[9/16]">
                                <div>
                                    <div class="loader mx-auto mb-2"></div>
                                    <p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o ki·ªÉu ${scenario.name}...</p>
                                </div>
                            </div>
                            <div class="h-5 bg-gray-300 rounded w-1/2 animate-pulse mt-auto"></div>
                        </div>`;
                    albumResultsGrid.insertAdjacentHTML('beforeend', loadingCard);

                    try {
                        const finalPrompt = `**Task:** Create a new version of the provided photograph.
**Analyze Source Image:** Carefully analyze the provided image.
**CRITICAL INSTRUCTION - RETAIN EVERYTHING:** You must retain 100% of the original image's elements: the exact person (face, body, hair), their complete outfit, AND the entire background/scene including all objects, lighting, and overall atmosphere. Everything must look identical to the original.
**THE ONLY CHANGE:** The person's pose AND/OR the camera angle must be different, as described here: "${scenario.prompt}".
The final image must be hyper-realistic and look like it was taken in the same location, at the same time, with just a different pose or camera angle.`;
                        
                        const result = await callGeminiApi(finalPrompt, [{ data: albumSourceBase64, mimeType: albumSourceMimeType }]);
                        const candidate = result?.candidates?.[0];
                        const loadingElement = document.getElementById(loadingCardId);

                        if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                            const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const resultCard = `
                                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                    <div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden regenerate-loader z-10 rounded-xl"><div class="loader"></div></div>
                                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[9/16]"><img src="${imageUrl}" alt="Bi·∫øn th·ªÉ ${scenario.name}" class="w-full h-full cursor-pointer generated-image object-cover"></div>
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center w-full"><h4 class="font-bold text-lg text-left text-gray-800">${scenario.name}</h4><a href="${imageUrl}" download="album_${scenario.id}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap download-btn">T·∫£i</a></div>
                                        <button class="text-xs text-blue-600 hover:underline mt-1 prompt-toggle-btn">Xem chi ti·∫øt prompt</button>
                                        <button class="text-xs text-indigo-600 hover:underline mt-1 ml-2 edit-btn">Ch·ªânh s·ª≠a & Th√™m chi ti·∫øt</button>
                                        <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded hidden prompt-details break-words">${finalPrompt.replace(/"/g, '&quot;')}</p>
                                        <div class="mt-2 hidden edit-controls"><textarea class="w-full p-2 border rounded-md text-sm edit-prompt-input" rows="2" placeholder="V√≠ d·ª•: th√™m m·ªôt chi·∫øc t√∫i x√°ch m√†u ƒë·ªè..."></textarea><button class="w-full mt-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm regenerate-btn">T·∫°o l·∫°i</button></div>
                                    </div>
                                </div>
                            `;
                            if (loadingElement) {
                                loadingElement.outerHTML = resultCard;
                                albumResultsGrid.querySelector(`[alt="Bi·∫øn th·ªÉ ${scenario.name}"]`).addEventListener('click', (e) => {
                                    zoomedImage.src = e.target.src;
                                    zoomModal.classList.remove('hidden');
                                });
                            }
                        } else {
                            if (loadingElement) loadingElement.remove();
                            throw new Error("Ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá.");
                        }
                    } catch(error) {
                        console.error(`Error generating album variation ${scenario.name}:`, error);
                        const loadingElement = document.getElementById(loadingCardId);
                        if (loadingElement) loadingElement.remove();
                        showError(error.message);
                    }
                }
            } else {
                const productAngleScenarios = [
                    { name: "G√≥c 3/4", prompt: "Ch·ª•p s·∫£n ph·∫©m t·ª´ g√≥c nghi√™ng 3/4, th·ªÉ hi·ªán m·ªôt ch√∫t chi·ªÅu s√¢u v√† chi ti·∫øt b√™n h√¥ng. AI c·∫ßn suy lu·∫≠n m·ªôt c√°ch h·ª£p l√Ω ƒë·ªÉ t√°i t·∫°o c√°c chi ti·∫øt b√™n h√¥ng d·ª±a tr√™n g√≥c nh√¨n ch√≠nh di·ªán." },
                    { name: "G√≥c Ch·ª•p Sau", prompt: "Ch·ª•p s·∫£n ph·∫©m t·ª´ ph√≠a sau. AI c·∫ßn s√°ng t·∫°o nh∆∞ng ph·∫£i nh·∫•t qu√°n v·ªõi thi·∫øt k·∫ø ph√≠a tr∆∞·ªõc ƒë·ªÉ t√°i t·∫°o m·∫∑t sau c·ªßa s·∫£n ph·∫©m m·ªôt c√°ch h·ª£p l√Ω." },
                    { name: "Trung C·∫£nh", prompt: "Ch·ª•p s·∫£n ph·∫©m t·ª´ g√≥c trung c·∫£nh (t·ª´ kho·∫£ng n·ª≠a tr√™n c·ªßa s·∫£n ph·∫©m tr·ªü l√™n), gi·ªØ nguy√™n b·ªë c·ª•c v√† b·ªëi c·∫£nh." },
                    { name: "C·∫≠n C·∫£nh", prompt: "Ch·ª•p m·ªôt g√≥c c·∫≠n c·∫£nh h∆°n v√†o s·∫£n ph·∫©m, t·∫≠p trung v√†o ph·∫ßn th√¢n tr√™n ho·∫∑c m·ªôt khu v·ª±c quan tr·ªçng." },
                    { name: "Chi Ti·∫øt N·ªïi B·∫≠t", prompt: "Ch·ª•p c·∫≠n c·∫£nh m·ªôt chi ti·∫øt n·ªïi b·∫≠t c·ªßa s·∫£n ph·∫©m (v√≠ d·ª•: c·ªï √°o, khuy c√†i, h·ªça ti·∫øt, logo). S·ª≠ d·ª•ng hi·ªáu ·ª©ng x√≥a ph√¥ng (bokeh) nh·∫π ·ªü h·∫≠u c·∫£nh ƒë·ªÉ l√†m n·ªïi b·∫≠t chi ti·∫øt ƒë∆∞·ª£c ch·ª•p." },
                    { name: "C·∫≠n C·∫£nh Ch·∫•t V·∫£i", prompt: "Ch·ª•p macro (c·ª±c c·∫≠n) ƒë·ªÉ th·ªÉ hi·ªán r√µ k·∫øt c·∫•u v√† ch·∫•t li·ªáu c·ªßa v·∫£i. √Ånh s√°ng ph·∫£i l√†m n·ªïi b·∫≠t t·ª´ng s·ª£i v·∫£i." },
                    { name: "G√≥c Th·∫•p", prompt: "Ch·ª•p s·∫£n ph·∫©m t·ª´ m·ªôt g√≥c th·∫•p nh√¨n l√™n, t·∫°o c·∫£m gi√°c s·∫£n ph·∫©m tr√¥ng l·ªõn v√† ·∫•n t∆∞·ª£ng h∆°n." }
                ];
                
                for (const scenario of productAngleScenarios) {
                    const loadingCardId = `loading-album-${scenario.name.replace(/\s+/g, '-')}`;
                    const loadingCard = `
                        <div id="${loadingCardId}" class="bg-white p-4 rounded-xl shadow-lg flex flex-col">
                            <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-[9/16]">
                                <div><div class="loader mx-auto mb-2"></div><p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o ki·ªÉu ${scenario.name}...</p></div>
                            </div>
                            <div class="h-5 bg-gray-300 rounded w-1/2 animate-pulse mt-auto"></div>
                        </div>`;
                    albumResultsGrid.insertAdjacentHTML('beforeend', loadingCard);

                    try {
                        const finalPrompt = `**Nhi·ªám v·ª•:** T·∫°o m·ªôt phi√™n b·∫£n m·ªõi c·ªßa ·∫£nh g·ªëc ƒë∆∞·ª£c cung c·∫•p.\n**Ph√¢n t√≠ch & Gi·ªØ nguy√™n:** Ph√¢n t√≠ch k·ªπ l∆∞·ª°ng ·∫£nh g·ªëc. Gi·ªØ nguy√™n 100% s·∫£n ph·∫©m, b·ªëi c·∫£nh (background), ƒë·∫°o c·ª• (accessories), √°nh s√°ng, v√† phong c√°ch t·ªïng th·ªÉ c·ªßa ·∫£nh g·ªëc. M·ªçi y·∫øu t·ªë ph·∫£i y h·ªát ·∫£nh g·ªëc.\n**Thay ƒë·ªïi DUY NH·∫§T:** Thay ƒë·ªïi g√≥c ch·ª•p v√† b·ªë c·ª•c c·ªßa m√°y ·∫£nh ƒë·ªÉ t·∫°o ra m·ªôt g√≥c nh√¨n m·ªõi cho s·∫£n ph·∫©m.\n**Y√™u c·∫ßu g√≥c ch·ª•p c·ª• th·ªÉ:** ${scenario.prompt}.\n**Y√äU C·∫¶U C·∫§M:** TUY·ªÜT ƒê·ªêI KH√îNG S·ª¨ D·ª§NG NG∆Ø·ªúI M·∫™U ho·∫∑c b·∫•t k·ª≥ b·ªô ph·∫≠n c∆° th·ªÉ ng∆∞·ªùi n√†o trong ·∫£nh. Kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi s·∫£n ph·∫©m g·ªëc d∆∞·ªõi b·∫•t k·ª≥ h√¨nh th·ª©c n√†o.\n·∫¢nh cu·ªëi c√πng ph·∫£i c√≥ ch·∫•t l∆∞·ª£ng cao v√† tr√¥ng nh∆∞ ƒë∆∞·ª£c ch·ª•p trong c√πng m·ªôt bu·ªïi ch·ª•p v·ªõi ·∫£nh g·ªëc.`;
                        
                        const result = await callGeminiApi(finalPrompt, [{ data: albumSourceBase64, mimeType: albumSourceMimeType }]);
                        const candidate = result?.candidates?.[0];
                        const loadingElement = document.getElementById(loadingCardId);

                        if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                            const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const resultCard = `
                                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                    <div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden regenerate-loader z-10 rounded-xl"><div class="loader"></div></div>
                                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[9/16]"><img src="${imageUrl}" alt="Bi·∫øn th·ªÉ ${scenario.name}" class="w-full h-full cursor-pointer generated-image object-cover"></div>
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center w-full"><h4 class="font-bold text-lg text-left text-gray-800">${scenario.name}</h4><a href="${imageUrl}" download="album_${scenario.name.replace(/\s+/g, '_')}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap download-btn">T·∫£i</a></div>
                                        <button class="text-xs text-blue-600 hover:underline mt-1 prompt-toggle-btn">Xem chi ti·∫øt prompt</button>
                                        <button class="text-xs text-indigo-600 hover:underline mt-1 ml-2 edit-btn">Ch·ªânh s·ª≠a & Th√™m chi ti·∫øt</button>
                                        <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded hidden prompt-details break-words">${finalPrompt.replace(/"/g, '&quot;')}</p>
                                        <div class="mt-2 hidden edit-controls"><textarea class="w-full p-2 border rounded-md text-sm edit-prompt-input" rows="2" placeholder="V√≠ d·ª•: th√™m m·ªôt chi·∫øc t√∫i x√°ch m√†u ƒë·ªè..."></textarea><button class="w-full mt-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm regenerate-btn">T·∫°o l·∫°i</button></div>
                                    </div>
                                </div>
                            `;
                            if (loadingElement) {
                                loadingElement.outerHTML = resultCard;
                                albumResultsGrid.querySelector(`[alt="Bi·∫øn th·ªÉ ${scenario.name}"]`).addEventListener('click', (e) => {
                                    zoomedImage.src = e.target.src;
                                    zoomModal.classList.remove('hidden');
                                });
                            }
                        } else {
                            if (loadingElement) loadingElement.remove();
                            throw new Error("Ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá.");
                        }
                    } catch(error) {
                        console.error(`Error generating album variation ${scenario.name}:`, error);
                        const loadingElement = document.getElementById(loadingCardId);
                        if (loadingElement) loadingElement.remove();
                        showError(error.message);
                    }
                }
            }
        }

        if (generateAlbumWithModelBtn) generateAlbumWithModelBtn.addEventListener('click', () => generateAlbum(true));
        if (generateAlbumProductBtn) generateAlbumProductBtn.addEventListener('click', () => generateAlbum(false));

        // --- FESTIVAL TOOL ---
        const festivalSelection = document.getElementById('festivalSelection');
        const festivalGrid = document.getElementById('festivalGrid');
        const festivalResultsContainer = document.getElementById('festivalResultsContainer');
        const festivalResultsGrid = document.getElementById('festivalResultsGrid');
        let base64FestivalFaceData = null;
        let base64FestivalOutfitData = null;
        let festivalOutfitMimeType = null;

        const festivals = [
             {
                id: "tet",
                name: "T·∫øt Nguy√™n ƒê√°n",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang ƒë√≥n T·∫øt Nguy√™n ƒê√°n. B·ªëi c·∫£nh l√† m·ªôt con ƒë∆∞·ªùng ·ªü Vi·ªát Nam ƒë∆∞·ª£c trang tr√≠ r·ª±c r·ª° v·ªõi hoa mai v√†ng v√† ƒë√®n l·ªìng ƒë·ªè. Kh√¥ng kh√≠ th·∫≠t l·ªÖ h·ªôi v√† vui t∆∞∆°i. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "Kh√¥ng kh√≠ T·∫øt r·ªôn r√†ng v·ªõi hoa mai, ƒë√®n l·ªìng ƒë·ªè."
            },
            {
                id: "trung-thu",
                name: "T·∫øt Trung Thu",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang ƒë√≥n T·∫øt Trung Thu v√†o ban ƒë√™m. B·ªëi c·∫£nh l√† m·ªôt con ph·ªë Vi·ªát Nam nh·ªôn nh·ªãp, ƒë∆∞·ª£c chi·∫øu s√°ng b·ªüi nh·ªØng chi·∫øc ƒë√®n l·ªìng nhi·ªÅu m√†u s·∫Øc, ƒë·∫∑c bi·ªát l√† ƒë√®n l·ªìng h√¨nh ng√¥i sao v√† c√° ch√©p. Tr·∫ª em ƒëang ch∆°i ƒë√πa g·∫ßn ƒë√≥. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "ƒê√™m h·ªôi trƒÉng r·∫±m lung linh v·ªõi ƒë√®n √¥ng sao."
            },
            {
                id: "gio-to",
                name: "Gi·ªó T·ªï H√πng V∆∞∆°ng",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang vi·∫øng ƒê·ªÅn H√πng trong L·ªÖ h·ªôi Gi·ªó T·ªï H√πng V∆∞∆°ng. B·ªëi c·∫£nh cho th·∫•y ki·∫øn tr√∫c c·ªï k√≠nh c·ªßa khu ƒë·ªÅn tr√™n n√∫i Nghƒ©a Lƒ©nh, v·ªõi c√¢y c·ªëi xanh t∆∞∆°i. Kh√¥ng kh√≠ trang nghi√™m v√† ƒë·∫≠m ch·∫•t vƒÉn h√≥a. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "V·ªÅ c·ªôi ngu·ªìn d√¢n t·ªôc t·∫°i ƒê·ªÅn H√πng linh thi√™ng."
            },
            {
                id: "quoc-khanh",
                name: "L·ªÖ Qu·ªëc Kh√°nh 2/9",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang m·ª´ng L·ªÖ Qu·ªëc Kh√°nh Vi·ªát Nam (2/9). B·ªëi c·∫£nh l√† m·ªôt con ph·ªë l·ªõn ·ªü m·ªôt th√†nh ph·ªë Vi·ªát Nam, ƒë∆∞·ª£c trang tr√≠ b·∫±ng nhi·ªÅu c·ªù T·ªï qu·ªëc (c·ªù ƒë·ªè sao v√†ng). Kh√¥ng kh√≠ y√™u n∆∞·ªõc v√† t∆∞ng b·ª´ng. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "Kh√¥ng kh√≠ t·ª± h√†o, t∆∞ng b·ª´ng ng√†y T·∫øt ƒê·ªôc L·∫≠p."
            },
            {
                id: "ao-dai-festival",
                name: "L·ªÖ H·ªôi √Åo D√†i",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang tham gia L·ªÖ h·ªôi √Åo d√†i. B·ªëi c·∫£nh l√† m·ªôt danh lam th·∫Øng c·∫£nh mang t√≠nh bi·ªÉu t∆∞·ª£ng c·ªßa Vi·ªát Nam, nh∆∞ Kinh th√†nh Hu·∫ø ho·∫∑c Nh√† th·ªù ƒê·ª©c B√† ·ªü TP.HCM. C√≥ th·ªÉ th·∫•y nhi·ªÅu ng∆∞·ªùi kh√°c trong t√† √°o d√†i s·∫∑c s·ª° ·ªü h·∫≠u c·∫£nh, t·∫°o n√™n m·ªôt kh√¥ng kh√≠ s√¥i ƒë·ªông v√† thanh l·ªãch. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "T√¥n vinh v·∫ª ƒë·∫πp t√† √°o d√†i truy·ªÅn th·ªëng."
            },
            {
                id: "hoi-an-lantern",
                name: "L·ªÖ H·ªôi ƒê√®n L·ªìng H·ªôi An",
                prompt: "T·∫°o m·ªôt b·ª©c ·∫£nh ngo·∫°i c·∫£nh, si√™u th·ª±c t·∫ø, ch·∫•t l∆∞·ª£ng cao c·ªßa m·ªôt ng∆∞·ªùi ƒëang th∆∞·ªüng th·ª©c L·ªÖ h·ªôi ƒê√®n l·ªìng H·ªôi An v√†o ban ƒë√™m. B·ªëi c·∫£nh l√† ph·ªë c·ªï H·ªôi An v·ªõi nh·ªØng ng√¥i nh√† m√†u v√†ng ƒë·∫∑c tr∆∞ng v√† s√¥ng Ho√†i ƒë·∫ßy nh·ªØng chi·∫øc ƒë√®n hoa ƒëƒÉng tr√¥i n·ªïi. Khung c·∫£nh huy·ªÅn ·∫£o v√† ƒë∆∞·ª£c chi·∫øu s√°ng ƒë·∫πp m·∫Øt b·ªüi h√†ng ng√†n chi·∫øc ƒë√®n l·ªìng l·ª•a nhi·ªÅu m√†u s·∫Øc. Ng∆∞·ªùi trong ·∫£nh ph·∫£i m·∫∑c trang ph·ª•c ƒë∆∞·ª£c cung c·∫•p.",
                description: "Ph·ªë c·ªï H·ªôi An huy·ªÅn ·∫£o trong ƒë√™m h·ªôi hoa ƒëƒÉng."
            },
        ];

        function checkFestivalUploads() {
            if(base64FestivalFaceData && base64FestivalOutfitData) {
                if (festivalSelection) festivalSelection.classList.remove('hidden');
            } else {
                if (festivalSelection) festivalSelection.classList.add('hidden');
            }
        }
        
        setupImageUpload('festivalFaceImageUpload', 'festivalFaceUploadButton', null, 'festivalFaceFileName', 'festivalFaceImagePreviewContainer', 'festivalFaceImagePreview', (data) => { base64FestivalFaceData = data; checkFestivalUploads(); }, () => { base64FestivalFaceData = null; checkFestivalUploads(); });
        setupImageUpload('festivalOutfitImageUpload', 'festivalOutfitUploadButton', null, 'festivalOutfitFileName', 'festivalOutfitImagePreviewContainer', 'festivalOutfitImagePreview', (data, type) => { base64FestivalOutfitData = data; festivalOutfitMimeType = type; checkFestivalUploads(); }, () => { base64FestivalOutfitData = null; checkFestivalUploads(); });
        populateGrid(festivalGrid, festivals, 'festival-card');
        
        if (festivalGrid) {
            festivalGrid.addEventListener('click', async (e) => {
                const card = e.target.closest('.festival-card');
                if(!card) return;

                 if (!base64FestivalFaceData || !base64FestivalOutfitData) {
                    showError("Vui l√≤ng t·∫£i l√™n c·∫£ ·∫£nh ch√¢n dung v√† ·∫£nh trang ph·ª•c.");
                    return;
                }

                festivalGrid.querySelectorAll('.festival-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                const selectedFestival = festivals.find(f => f.id === card.dataset.id);
                if (!selectedFestival) return;

                festivalResultsContainer.classList.remove('hidden');
                festivalResultsGrid.innerHTML = '';
                festivalResultsContainer.scrollIntoView({ behavior: 'smooth' });

                for(let i = 0; i < 4; i++) {
                    const loadingCardId = `loading-festival-card-${i}`;
                    const loadingCard = `
                        <div id="${loadingCardId}" class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                            <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-[9/16]">
                                 <div>
                                     <div class="loader mx-auto mb-2"></div>
                                     <p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o ·∫£nh l·ªÖ h·ªôi...</p>
                                </div>
                            </div>
                            <div class="h-5 bg-gray-300 rounded w-1/2 animate-pulse mt-auto"></div>
                        </div>`;
                    festivalResultsGrid.insertAdjacentHTML('beforeend', loadingCard);

                     try {
                         const basePrompt = `**Y√äU C·∫¶U QUAN TR·ªåNG NH·∫§T - TUY·ªÜT ƒê·ªêI KH√îNG THAY ƒê·ªîI:** Khu√¥n m·∫∑t c·ªßa nh√¢n v·∫≠t trong ·∫£nh k·∫øt qu·∫£ PH·∫¢I L√Ä B·∫¢N SAO CH√çNH X√ÅC 1:1 c·ªßa khu√¥n m·∫∑t trong ·∫£nh ch√¢n dung ƒë√£ cung c·∫•p. Nh√¢n v·∫≠t ph·∫£i m·∫∑c ch√≠nh x√°c b·ªô trang ph·ª•c t·ª´ ·∫£nh trang ph·ª•c. ƒê√¢y l√† ∆∞u ti√™n s·ªë m·ªôt.`;
                         const finalPrompt = `${basePrompt} ${selectedFestival.prompt} Phong c√°ch nhi·∫øp ·∫£nh si√™u th·ª±c, ch·∫•t l∆∞·ª£ng ƒëi·ªán ·∫£nh, 8k.`;
                         
                         const imagesToApi = [
                             { data: base64FestivalFaceData, mimeType: 'image/jpeg' },
                             { data: base64FestivalOutfitData, mimeType: festivalOutfitMimeType }
                         ];

                         const result = await callGeminiApi(finalPrompt, imagesToApi);
                         const candidate = result?.candidates?.[0];
                         const loadingElement = document.getElementById(loadingCardId);

                         if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                            const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const resultCardHTML = `
                                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                    <div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden regenerate-loader z-10 rounded-xl">
                                        <div class="loader"></div>
                                    </div>
                                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[9/16]">
                                        <img src="${imageUrl}" alt="${selectedFestival.name} Image ${i + 1}" class="w-full h-full cursor-pointer generated-image object-cover">
                                    </div>
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center w-full">
                                            <h4 class="font-bold text-lg text-left text-gray-800">${selectedFestival.name} #${i + 1}</h4>
                                            <a href="${imageUrl}" download="${selectedFestival.id}_${i + 1}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap download-btn">T·∫£i</a>
                                        </div>
                                        <button class="text-xs text-blue-600 hover:underline mt-1 prompt-toggle-btn">Xem chi ti·∫øt prompt</button>
                                         <button class="text-xs text-indigo-600 hover:underline mt-1 ml-2 edit-btn">Ch·ªânh s·ª≠a & Th√™m chi ti·∫øt</button>
                                        <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded hidden prompt-details break-words">
                                            ${finalPrompt.replace(/"/g, '&quot;')}
                                        </p>
                                        <div class="mt-2 hidden edit-controls">
                                            <textarea class="w-full p-2 border rounded-md text-sm edit-prompt-input" rows="2" placeholder="V√≠ d·ª•: th√™m m·ªôt chi·∫øc t√∫i x√°ch m√†u ƒë·ªè..."></textarea>
                                            <button class="w-full mt-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm regenerate-btn">T·∫°o l·∫°i</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            if(loadingElement) {
                                 loadingElement.outerHTML = resultCardHTML;
                                 const newImg = festivalResultsGrid.querySelector(`[alt="${selectedFestival.name} Image ${i + 1}"]`);
                                 if(newImg) {
                                     newImg.addEventListener('click', (e) => {
                                         zoomedImage.src = e.target.src;
                                         zoomModal.classList.remove('hidden');
                                     });
                                 }
                            }

                         } else {
                             if (loadingElement) loadingElement.remove();
                             throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh h·ª£p l·ªá.");
                         }

                     } catch(error) {
                         console.error('Error generating festival image:', error);
                         const loadingElement = document.getElementById(loadingCardId);
                         if (loadingElement) loadingElement.remove();
                         showError(`L·ªói t·∫°o ·∫£nh: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                     }
                 }
            });
        }
        

        // --- AI STYLIST TOOL ---
        const stylistUploadSection = document.getElementById('stylistUploadSection');
        const stylistSourceImageUpload = document.getElementById('stylistSourceImageUpload');
        const stylistSourceUploadButton = document.getElementById('stylistSourceUploadButton');
        const stylistSourceFileName = document.getElementById('stylistSourceFileName');
        const stylistSourceImagePreviewContainer = document.getElementById('stylistSourceImagePreviewContainer');
        const stylistSourceImagePreview = document.getElementById('stylistSourceImagePreview');
        const stylistActionSection = document.getElementById('stylistActionSection');
        const generateStyledSetButton = document.getElementById('generateStyledSetButton');
        const stylistResultsContainer = document.getElementById('stylistResultsContainer');
        const stylistOriginalImageDisplay = document.getElementById('stylistOriginalImageDisplay');
        const stylistResultsGrid = document.getElementById('stylistResultsGrid');
        const stylistResetButton = document.getElementById('stylistResetButton');
        const stylistFabricImageUpload = document.getElementById('stylistFabricImageUpload');
        const stylistFabricUploadButton = document.getElementById('stylistFabricUploadButton');
        const stylistFabricFileName = document.getElementById('stylistFabricFileName');
        const stylistFabricImagePreviewContainer = document.getElementById('stylistFabricImagePreviewContainer');
        const stylistFabricImagePreview = document.getElementById('stylistFabricImagePreview');

        let stylistSourceBase64 = null;
        let stylistSourceMimeType = null;
        let stylistFabricBase64 = null;
        let stylistFabricMimeType = null;
        
        if (stylistSourceImageUpload) {
            setupImageUpload(
                'stylistSourceImageUpload', 'stylistSourceUploadButton', 'stylistSourceClearButton', 'stylistSourceFileName', 
                'stylistSourceImagePreviewContainer', 'stylistSourceImagePreview', 
                (data, type) => { // onUpload
                    stylistSourceBase64 = data;
                    stylistSourceMimeType = type;
                    if(stylistOriginalImageDisplay) stylistOriginalImageDisplay.src = `data:${type};base64,${data}`;
                    if(stylistSourceImagePreviewContainer) stylistSourceImagePreviewContainer.classList.remove('hidden');
                    if(stylistActionSection) stylistActionSection.classList.remove('hidden');
                }, 
                () => { // onClear
                    stylistSourceBase64 = null;
                    stylistSourceMimeType = null;
                    if(stylistActionSection) stylistActionSection.classList.add('hidden');
                    if(stylistResultsContainer) stylistResultsContainer.classList.add('hidden');
                    if(stylistResultsGrid) stylistResultsGrid.innerHTML = '';
                    if(stylistOriginalImageDisplay) stylistOriginalImageDisplay.src = '';
                }
            );
        }

        if (stylistFabricImageUpload) {
            setupImageUpload(
                'stylistFabricImageUpload', 'stylistFabricUploadButton', 'stylistFabricClearButton', 
                'stylistFabricFileName', 'stylistFabricImagePreviewContainer', 'stylistFabricImagePreview', 
                (data, type) => {
                    stylistFabricBase64 = data;
                    stylistFabricMimeType = type;
                }, 
                () => {
                    stylistFabricBase64 = null;
                    stylistFabricMimeType = null;
                }
            );
        }
        
        if (generateStyledSetButton) {
            generateStyledSetButton.addEventListener('click', async () => {
                if (!stylistSourceBase64) {
                    showError("Vui l√≤ng t·∫£i l√™n m·ªôt ·∫£nh trang ph·ª•c ch√≠nh.");
                    return;
                }
                stylistResultsContainer.classList.remove('hidden');
                stylistResultsContainer.scrollIntoView({ behavior: 'smooth' });
                if(stylistResultsGrid) stylistResultsGrid.innerHTML = '';

                const imagesToApi = [{ data: stylistSourceBase64, mimeType: stylistSourceMimeType }];
                let fabricInstruction = '';
                if (stylistFabricBase64) {
                    fabricInstruction = ` **CRITICAL TEXTURE INSTRUCTION:** The texture, pattern, and material of the outfit MUST EXACTLY match the provided close-up fabric image. Use this second image as the definitive reference for the outfit's material properties.`;
                    imagesToApi.push({ data: stylistFabricBase64, mimeType: stylistFabricMimeType });
                }
                
                const imagesForAccessoriesPrompt = [{ data: stylistSourceBase64, mimeType: stylistSourceMimeType }];

                const tasks = [
                    {
                        title: 'S·∫£n ph·∫©m + Ph·ª• ki·ªán',
                        prompt: `You are an expert AI fashion stylist. Your task is to create a professional flat-lay product shot. Look at the provided image of a person. First, meticulously identify and isolate their complete outfit (top, bottom, dress, etc.). Then, create a brand new image where this exact outfit is neatly laid out on a solid, neutral light grey background (#e0e0e0). To complete the look, add three perfectly matching and stylish accessories (like a handbag, shoes, and jewelry) tastefully arranged around the outfit. The final image must be ultra-realistic, clean, well-lit, and look like it's from a high-end fashion catalog. Do not include the person from the original photo.` + fabricInstruction,
                        images: imagesToApi,
                        id: 'full_set'
                    },
                    {
                        title: 'Ch·ªâ s·∫£n ph·∫©m',
                        prompt: `You are an expert AI product photographer. Your task is to create a professional flat-lay product shot. Look at the provided image of a person. Meticulously identify and isolate their complete outfit (top, bottom, dress, etc.). Create a brand new image where this exact outfit is neatly laid out on a solid, neutral light grey background (#e0e0e0). **CRITICAL INSTRUCTION: Do NOT add any other items or accessories.** The image should only contain the isolated outfit. The final image must be ultra-realistic, clean, well-lit, and look like a professional product photo for an e-commerce website. Do not include the person from the original photo.` + fabricInstruction,
                        images: imagesToApi,
                        id: 'outfit_only'
                    },
                    {
                        title: 'Ch·ªâ ph·ª• ki·ªán',
                        prompt: `You are an expert AI fashion stylist. Your task is to curate a set of accessories. Look at the provided image of a person and analyze their complete outfit's style, color, and fabric. Based on this analysis, create a brand new image showing a set of three perfectly matching and stylish accessories (for example, a handbag, a pair of shoes, and some jewelry) that would complement the outfit. **CRITICAL INSTRUCTION: The accessories must be neatly laid out on a solid, neutral light grey background (#e0e0e0). Do NOT include the original outfit or the person in the final image.** The final image must be an ultra-realistic, clean, well-lit product shot of only the accessories.`,
                        images: imagesForAccessoriesPrompt,
                        id: 'accessories_only'
                    }
                ];

                tasks.forEach((task, index) => {
                    const loadingCard = `
                        <div id="stylist-loading-card-${index}" class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                            <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-square">
                                 <div>
                                     <div class="loader mx-auto mb-2"></div>
                                     <p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o:<br>${task.title}</p>
                                </div>
                            </div>
                            <div class="h-5 bg-gray-300 rounded w-full animate-pulse mt-auto"></div>
                        </div>`;
                    stylistResultsGrid.insertAdjacentHTML('beforeend', loadingCard);
                });

                tasks.forEach(async (task, index) => {
                    try {
                        const result = await callGeminiApi(task.prompt, task.images);
                        const candidate = result?.candidates?.[0];
                        const loadingElement = document.getElementById(`stylist-loading-card-${index}`);

                        if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                            const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const resultCardHTML = `
                                <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                    <div class="w-full rounded-lg mb-4 overflow-hidden aspect-square">
                                        <img src="${imageUrl}" alt="${task.title}" class="w-full h-full cursor-pointer generated-image object-cover">
                                    </div>
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center w-full">
                                            <h4 class="font-bold text-lg text-left text-gray-800">${task.title}</h4>
                                            <a href="${imageUrl}" download="styled_${task.id}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap">T·∫£i</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                            if(loadingElement) {
                                loadingElement.outerHTML = resultCardHTML;
                                const newImg = stylistResultsGrid.querySelector(`img[alt="${task.title}"]`);
                                if(newImg) newImg.addEventListener('click', (e) => { zoomedImage.src = e.target.src; zoomModal.classList.remove('hidden'); });
                            }
                        } else {
                            throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh h·ª£p l·ªá.");
                        }
                    } catch (error) {
                        console.error(`Error generating image for "${task.title}":`, error);
                        const loadingElement = document.getElementById(`stylist-loading-card-${index}`);
                        if (loadingElement) {
                            loadingElement.innerHTML = `<div class="text-center text-red-500 p-4 flex items-center justify-center h-full">L·ªói khi t·∫°o ·∫£nh "${task.title}".</div>`;
                        }
                        showError(`L·ªói t·∫°o ·∫£nh "${task.title}": ${error.message}`);
                    }
                });
            });
        }
        
        if (stylistResetButton) {
            stylistResetButton.addEventListener('click', () => {
                stylistResultsContainer.classList.add('hidden');
                
                // Programmatically click the clear buttons if an image has been uploaded
                // This reuses the logic defined in the setupImageUpload's onClear callback
                const sourceClearBtn = document.getElementById('stylistSourceClearButton');
                const fabricClearBtn = document.getElementById('stylistFabricClearButton');
                if (stylistSourceBase64 && sourceClearBtn) {
                     sourceClearBtn.click();
                }
                if (stylistFabricBase64 && fabricClearBtn) {
                     fabricClearBtn.click();
                }
            });
        }
        

        // --- AI LOOKBOOK TOOL ---
        const lookbookSourceImageUpload = document.getElementById('lookbookSourceImageUpload');
        const lookbookRatioSelection = document.getElementById('lookbookRatioSelection');
        const lookbookStyleCreation = document.getElementById('lookbookStyleCreation');
        const lookbookCustomPrompt = document.getElementById('lookbookCustomPrompt');
        const addLookbookImageButton = document.getElementById('addLookbookImageButton');
        const lookbookResultsContainer = document.getElementById('lookbookResultsContainer');
        const lookbookResultsGrid = document.getElementById('lookbookResultsGrid');
        const clearLookbookResultsButton = document.getElementById('clearLookbookResultsButton');

        let lookbookSourceBase64 = null;
        let lookbookSourceMimeType = null;
        let selectedLookbookRatioPrompt = null;
        let lookbookReferenceBase64 = null;
        let lookbookReferenceMimeType = null;
        
        function checkLookbookSteps() {
            if (!lookbookRatioSelection || !lookbookStyleCreation) return;
            lookbookRatioSelection.classList.add('hidden');
            lookbookStyleCreation.classList.add('hidden');

            if (lookbookSourceBase64) {
                 lookbookRatioSelection.classList.remove('hidden');
            }
            if(selectedLookbookRatioPrompt) {
                lookbookStyleCreation.classList.remove('hidden');
            }
        }
        
        if (lookbookSourceImageUpload) {
            setupImageUpload('lookbookSourceImageUpload', 'lookbookSourceUploadButton', 'lookbookSourceClearButton', 'lookbookSourceFileName', 'lookbookSourceImagePreviewContainer', 'lookbookSourceImagePreview', (data, type) => {
                 lookbookSourceBase64 = data;
                 lookbookSourceMimeType = type;
                 checkLookbookSteps();
            }, () => {
                lookbookSourceBase64 = null;
                lookbookSourceMimeType = null;
                selectedLookbookRatioPrompt = null;
                if (document.getElementById('lookbookReferenceClearButton')) document.getElementById('lookbookReferenceClearButton').click(); // Also clear reference
                const ratioCards = lookbookRatioSelection.querySelectorAll('.aspect-ratio-card');
                if (ratioCards) ratioCards.forEach(c => c.classList.remove('selected'));
                checkLookbookSteps();
                lookbookResultsContainer.classList.add('hidden');
                lookbookResultsGrid.innerHTML = '';
            });
        }
        
        setupImageUpload('lookbookReferenceImageUpload', 'lookbookReferenceUploadButton', 'lookbookReferenceClearButton', 'lookbookReferenceFileName', 'lookbookReferenceImagePreviewContainer', 'lookbookReferenceImagePreview', (data, type) => {
             lookbookReferenceBase64 = data;
             lookbookReferenceMimeType = type;
        }, () => {
            lookbookReferenceBase64 = null;
            lookbookReferenceMimeType = null;
        });
        
        handleSelection(lookbookRatioSelection, 'aspect-ratio-card', (prompt, id) => {
            selectedLookbookRatioPrompt = prompt;
            checkLookbookSteps();
        });

        if (addLookbookImageButton) {
            addLookbookImageButton.addEventListener('click', async () => {
                const customPrompt = lookbookCustomPrompt.value.trim();
                const hasReferenceImage = !!lookbookReferenceBase64;

                if (!lookbookSourceBase64 || !selectedLookbookRatioPrompt) {
                    showError("Vui l√≤ng t·∫£i ·∫£nh s·∫£n ph·∫©m v√† ch·ªçn t·ªâ l·ªá tr∆∞·ªõc khi t·∫°o ki·ªÉu.");
                    return;
                }
                if (!customPrompt && !hasReferenceImage) {
                    showError("Vui l√≤ng nh·∫≠p m√¥ t·∫£ ho·∫∑c t·∫£i l√™n ·∫£nh tham chi·∫øu ·ªü B∆∞·ªõc 3.");
                    return;
                }

                lookbookResultsContainer.classList.remove('hidden');
                lookbookResultsContainer.scrollIntoView({ behavior: 'smooth' });

                const loadingCardId = `loading-lookbook-card-${Date.now()}`;
                const loadingCard = `
                    <div id="${loadingCardId}" class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                        <div class="w-full rounded-lg mb-4 bg-gray-200 flex items-center justify-center aspect-[3/4]">
                            <div>
                                <div class="loader mx-auto mb-2"></div>
                                <p class="font-semibold text-gray-600 text-sm text-center">ƒêang t·∫°o ·∫£nh...</p>
                            </div>
                        </div>
                        <div class="h-5 bg-gray-300 rounded w-1/2 animate-pulse mt-auto"></div>
                    </div>`;
                lookbookResultsGrid.insertAdjacentHTML('beforeend', loadingCard);

                try {
                    let finalLookbookPrompt;
                    const imagesToApi = [{ data: lookbookSourceBase64, mimeType: lookbookSourceMimeType }];

                    if (hasReferenceImage) {
                        imagesToApi.push({ data: lookbookReferenceBase64, mimeType: lookbookReferenceMimeType });
                        finalLookbookPrompt = `You are an expert AI product photographer creating a new, hyper-realistic product shot.
                        **ANALYSIS:**
                        1.  **Image 1 (Product):** This is the primary product. You must extract this exact product, preserving its shape, details, color, and texture 100%.
                        2.  **Image 2 (Style Reference):** This image provides the style, composition, background, lighting, and overall mood for the new photo.
                        **CRITICAL INSTRUCTIONS:**
                        1.  Place the **product from Image 1** into the **scene and style of Image 2**.
                        2.  **STRICT PROHIBITION:** DO NOT use any human model or human parts. The final image should be a product shot only.
                        3.  The final image must look professional, like it belongs in a high-end catalog and must be in ${selectedLookbookRatioPrompt} format.`;
                        
                        if (customPrompt) {
                            finalLookbookPrompt += `\n**Additional Text Description:** Use these details to further refine the final image: "${customPrompt}". For example, if the text says "add a small plant", add a plant to the scene from Image 2.`;
                        }

                    } else {
                        finalLookbookPrompt = `You are an AI product photographer. Your task is to create a professional, hyper-realistic product shot.
                        **CRITICAL REQUIREMENT:** Take the exact clothing item from the provided image and retain its shape, details, and color 100%. Do not alter the original product.
                        **STRICT PROHIBITION:** DO NOT USE A HUMAN MODEL or any human body parts in the photo.
                        **SCENE DESCRIPTION:** The product should be presented in the following scene: "${customPrompt}".
                        The final image must be high-quality, well-lit, with a professional composition like a high-end fashion catalog. The image must be in ${selectedLookbookRatioPrompt} format.`;
                    }
                    
                    const result = await callGeminiApi(finalLookbookPrompt, imagesToApi);
                    const candidate = result?.candidates?.[0];
                    const loadingElement = document.getElementById(loadingCardId);

                    if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                        const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        const resultCardHTML = `
                            <div class="result-card bg-white p-4 rounded-xl shadow-lg flex flex-col">
                                <div class="w-full rounded-lg mb-4 overflow-hidden aspect-[3/4]">
                                    <img src="${imageUrl}" alt="Product Image" class="w-full h-full cursor-pointer generated-image object-cover">
                                </div>
                                <div class="mt-auto">
                                    <div class="flex justify-between items-center w-full">
                                        <h4 class="font-bold text-lg text-left text-gray-800">·∫¢nh t√πy ch·ªânh</h4>
                                        <a href="${imageUrl}" download="product_shot_custom_${Date.now()}.png" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-sm whitespace-nowrap download-btn">T·∫£i</a>
                                    </div>
                                    <button class="text-xs text-blue-600 hover:underline mt-1 prompt-toggle-btn">Xem chi ti·∫øt prompt</button>
                                    <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded hidden prompt-details break-words">
                                        ${finalLookbookPrompt.replace(/"/g, '&quot;')}
                                    </p>
                                </div>
                            </div>
                        `;
                        if(loadingElement) {
                             loadingElement.outerHTML = resultCardHTML;
                             const newImg = Array.from(lookbookResultsGrid.querySelectorAll('.generated-image')).pop();
                             if(newImg) {
                                 newImg.addEventListener('click', (e) => {
                                     zoomedImage.src = e.target.src;
                                     zoomModal.classList.remove('hidden');
                                 });
                             }
                        }
                    } else {
                        if (loadingElement) loadingElement.remove();
                        throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh s·∫£n ph·∫©m h·ª£p l·ªá.");
                    }
                } catch (error) {
                    console.error('Error generating product image:', error);
                    const loadingElement = document.getElementById(loadingCardId);
                    if (loadingElement) loadingElement.remove();
                    showError(`L·ªói t·∫°o ·∫£nh: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                }
            });
        }
        
        if (clearLookbookResultsButton) {
            clearLookbookResultsButton.addEventListener('click', () => {
                lookbookResultsGrid.innerHTML = '';
                lookbookResultsContainer.classList.add('hidden');
            });
        }


        // --- GENERIC API CALL ---
        async function callGeminiApi(prompt, images = [], retries = 3, delay = 1000) {
            const apiKey = MY_API_KEY; // V·ªä TR√ç 1: ƒê√É CH√àN
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            
            const parts = [ { text: prompt } ];
            images.forEach(img => {
                if (img.data && img.mimeType) {
                    parts.push({ inlineData: { mimeType: img.mimeType, data: img.data } });
                }
            });

            const payload = {
                contents: [{ parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
                  safetySettings: [
                    { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
                ],
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        console.error("API Error Response:", result);
                         const errorMessage = result?.error?.message || `HTTP error! status: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                        throw new Error("N·ªôi dung b·ªã ch·∫∑n v√¨ l√Ω do an to√†n. Vui l√≤ng th·ª≠ m·ªôt ·∫£nh ho·∫∑c y√™u c·∫ßu kh√°c.");
                    }
                    return result;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
        
        async function callGeminiApiForJson(prompt, images = []) {
             const apiKey = MY_API_KEY; // V·ªä TR√ç 2: ƒê√É CH√àN
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             const parts = [{ text: prompt }];
             images.forEach(img => {
                 if (img.data && img.mimeType) {
                     parts.push({ inlineData: { mimeType: img.mimeType, data: img.data } });
                 }
             });
             const payload = {
                 contents: [{ parts }],
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "ARRAY",
                         items: { "type": "STRING" }
                     }
                 }
             };

             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             const result = await response.json();
             if (!response.ok) {
                 console.error("JSON API Error Response:", result);
                 const errorMessage = result?.error?.message || `HTTP error! status: ${response.status}`;
                 throw new Error(errorMessage);
             }
             return result;
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function dataUrlToParts(dataUrl) {
            const parts = dataUrl.split(',');
            const mimeType = parts[0].match(/:(.*?);/)[1];
            const base64 = parts[1];
            return { base64, mimeType };
        }

        // --- GLOBAL EVENT LISTENERS FOR DYNAMIC CONTENT ---
        document.body.addEventListener('click', async e => {
            // Toggle prompt details visibility
            if (e.target.classList.contains('prompt-toggle-btn')) {
                const card = e.target.closest('.result-card');
                if (card) {
                    const details = card.querySelector('.prompt-details');
                    details.classList.toggle('hidden');
                    e.target.textContent = details.classList.contains('hidden') ? 'Xem chi ti·∫øt prompt' : '·∫®n chi ti·∫øt';
                }
            }

            // Toggle edit controls visibility
            if (e.target.classList.contains('edit-btn')) {
                 const card = e.target.closest('.result-card');
                 if (card) {
                     let controls = card.querySelector('.edit-controls');
                     controls.classList.toggle('hidden');
                 }
            }
            
            // Handle generic regeneration
            if (e.target.classList.contains('regenerate-btn')) {
                const card = e.target.closest('.result-card');
                if (!card) return;

                const sourceImageEl = card.querySelector('.generated-image');
                const loaderEl = card.querySelector('.regenerate-loader');
                const promptInput = card.querySelector('.edit-prompt-input');
                const downloadBtn = card.querySelector('.download-btn');

                const newPromptText = promptInput.value.trim();
                if (!newPromptText) {
                    showError("Vui l√≤ng nh·∫≠p chi ti·∫øt b·∫°n mu·ªën thay ƒë·ªïi.");
                    return;
                }
                
                loaderEl.classList.remove('hidden');
                e.target.disabled = true;

                try {
                    const sourceImageUrl = sourceImageEl.src;
                    const { base64: sourceBase64, mimeType: sourceMimeType } = dataUrlToParts(sourceImageUrl);
                    
                    const apiPrompt = `ƒê√¢y l√† ·∫£nh g·ªëc. H√£y ch·ªânh s·ª≠a n√≥ m·ªôt c√°ch tinh t·∫ø d·ª±a tr√™n y√™u c·∫ßu sau: "${newPromptText}". Gi·ªØ nguy√™n c√°c chi ti·∫øt kh√¥ng li√™n quan kh√°c c·ªßa ·∫£nh g·ªëc.`;

                    const result = await callGeminiApi(apiPrompt, [{ data: sourceBase64, mimeType: sourceMimeType }]);
                    const candidate = result?.candidates?.[0];
                    
                     if (candidate && candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data) {
                        const newBase64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                        const newImageUrl = `data:image/png;base64,${newBase64Data}`;

                        sourceImageEl.src = newImageUrl;
                        if (downloadBtn) downloadBtn.href = newImageUrl;
                        promptInput.value = ''; // Clear input after success
                    } else {
                        throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh h·ª£p l·ªá sau khi ch·ªânh s·ª≠a.");
                    }

                } catch(error) {
                    console.error("Error regenerating image:", error);
                    showError(`L·ªói khi t·∫°o l·∫°i ·∫£nh: ${error.message}`);
                } finally {
                    loaderEl.classList.add('hidden');
                    e.target.disabled = false;
                }
            }
        });

        if (closeModal) {
            closeModal.addEventListener('click', () => {
                zoomModal.classList.add('hidden');
            });
        }
        if (zoomModal) {
            zoomModal.addEventListener('click', (e) => {
                if (e.target === zoomModal) {
                    zoomModal.classList.add('hidden');
                }
            });
        }
        
    });
    </script>
</body>
</html>
